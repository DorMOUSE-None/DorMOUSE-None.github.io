<!DOCTYPE html>
<html lang="zh-cmn-Hans-CN" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    
    <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2020-10-19-hijack-http-req/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2020-10-19-hijack-http-req/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.ffutop.com/"
      },
      "articleSection" : "posts",
      "name" : "劫持 Java 应用 HTTP 请求",
      "headline" : "劫持 Java 应用 HTTP 请求",
      "description" : "\u003ch2 id=\"背景\"\u003e背景\u003c/h2\u003e\n\u003cp\u003e全链路追踪中，针对部分特殊的流量，希望将它引导到特定服务上（这个特定服务不在正常请求的链路上）——问题可以被抽象为解决进程间通信过程中目标进程的选择。\u003c/p\u003e\n\u003cp\u003e进程间通信方式很多，本篇只关注 Java 进程间套接字通信下 HTTP 形式的请求劫持，引导特定流量到特定进程。\u003c/p\u003e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2020",
      "datePublished": "2020-10-19T00:00:00Z",
      "dateModified" : "2020-10-19T00:00:00Z",
      "url" : "https://www.ffutop.com/posts/2020-10-19-hijack-http-req/",
      "keywords" : [ "HTTP","Hijack","Java", ]
  }
</script>
<title>劫持 Java 应用 HTTP 请求</title>
  <meta property="og:title" content="劫持 Java 应用 HTTP 请求" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="背景
全链路追踪中，针对部分特殊的流量，希望将它引导到特定服务上（这个特定服务不在正常请求的链路上）——问题可以被抽象为解决进程间通信过程中目标进程的选择。
进程间通信方式很多，本篇只关注 Java 进程间套接字通信下 HTTP 形式的请求劫持，引导特定流量到特定进程。" />
  <meta name="description" content="背景
全链路追踪中，针对部分特殊的流量，希望将它引导到特定服务上（这个特定服务不在正常请求的链路上）——问题可以被抽象为解决进程间通信过程中目标进程的选择。
进程间通信方式很多，本篇只关注 Java 进程间套接字通信下 HTTP 形式的请求劫持，引导特定流量到特定进程。" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/index.css">

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  
  
</head>

     
  </head>
  <body>
    
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">劫持 Java 应用 HTTP 请求</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2020-10-19 00:00:00 UTC">
                19 Oct 2020
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="背景">背景</h2>
<p>全链路追踪中，针对部分特殊的流量，希望将它引导到特定服务上（这个特定服务不在正常请求的链路上）——问题可以被抽象为解决进程间通信过程中目标进程的选择。</p>
<p>进程间通信方式很多，本篇只关注 Java 进程间套接字通信下 HTTP 形式的请求劫持，引导特定流量到特定进程。</p>
<h2 id="解决方案">解决方案</h2>
<p>可行的处理方案繁多。自顶向下从应用、框架、JVM、Container Runtime、System Call、网络协议栈等级别，均可着手解决。侵入性最强的操作就是要求所有业务应用都主动实现 HTTP 请求分流逻辑；次一级是提供二方库供业务应用主动集成；或者从系统层面进行改造，基于改写系统调用对请求进行劫持。</p>
<p>回顾两年前的所学，JVM TI 为劫持 HTTP 请求提供了一个全新的解决思路。通过 Agent 改写应用启动时加载的类的字节码，劫持类的实例并完成目标功能。</p>
<p>由于 Java 项目间调用大量的使用了 Apache 的 http-client 库，改写变得相当简单。识别流量，并对特定流量改写请求的 Host 即可。</p>
<h2 id="demo">Demo</h2>
<p>由于 http-client 对所有请求目标都统一由 <code>org.apache.http.HttpHost</code> 维护，控制变得极为简单。只需在 <code>HttpHost</code> 实例化时，改写类的构造方法，即完成了对目标的劫持工作（下例中强制将所有请求指向 <code>163.com</code>）</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Agent</span> <span style="color:#007020;font-weight:bold">implements</span> ClassFileTransformer <span style="color:#666">{</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">premain</span><span style="color:#666">(</span>String args<span style="color:#666">,</span> Instrumentation instrumentation<span style="color:#666">)</span> <span style="color:#666">{</span>
        instrumentation<span style="color:#666">.</span><span style="color:#4070a0">addTransformer</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> Agent<span style="color:#666">());</span>
    <span style="color:#666">}</span>

    <span style="color:#555;font-weight:bold">@Override</span>
    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">byte</span><span style="color:#666">[]</span> <span style="color:#06287e">transform</span><span style="color:#666">(</span>ClassLoader loader<span style="color:#666">,</span> String className<span style="color:#666">,</span> Class<span style="color:#666">&lt;?&gt;</span> classBeingRedefined<span style="color:#666">,</span> ProtectionDomain protectionDomain<span style="color:#666">,</span> <span style="color:#902000">byte</span><span style="color:#666">[]</span> classfileBuffer<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> IllegalClassFormatException <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#4070a0">&#34;org/apache/http/HttpHost&#34;</span><span style="color:#666">.</span><span style="color:#4070a0">equals</span><span style="color:#666">(</span>className<span style="color:#666">))</span> <span style="color:#666">{</span>
            ClassPool pool <span style="color:#666">=</span> ClassPool<span style="color:#666">.</span><span style="color:#4070a0">getDefault</span><span style="color:#666">();</span>
            <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
                CtClass httpHost <span style="color:#666">=</span> pool<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;org.apache.http.HttpHost&#34;</span><span style="color:#666">);</span>
                CtClass string <span style="color:#666">=</span> pool<span style="color:#666">.</span><span style="color:#4070a0">get</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;java.lang.String&#34;</span><span style="color:#666">);</span>
                CtConstructor constructor <span style="color:#666">=</span> httpHost<span style="color:#666">.</span><span style="color:#4070a0">getDeclaredConstructor</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> CtClass<span style="color:#666">[]{</span>string<span style="color:#666">,</span> CtClass<span style="color:#666">.</span><span style="color:#4070a0">intType</span><span style="color:#666">,</span> string<span style="color:#666">});</span>
                constructor<span style="color:#666">.</span><span style="color:#4070a0">insertBefore</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;hostname = \&#34;www.163.com\&#34;;&#34;</span><span style="color:#666">);</span>
                <span style="color:#902000">byte</span><span style="color:#666">[]</span> bytes <span style="color:#666">=</span> httpHost<span style="color:#666">.</span><span style="color:#4070a0">toBytecode</span><span style="color:#666">();</span>
                FileOutputStream fos <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> FileOutputStream<span style="color:#666">(</span><span style="color:#4070a0">&#34;/Users/fangfeng/a.class&#34;</span><span style="color:#666">);</span>
                fos<span style="color:#666">.</span><span style="color:#4070a0">write</span><span style="color:#666">(</span>bytes<span style="color:#666">);</span>
                <span style="color:#007020;font-weight:bold">return</span> bytes<span style="color:#666">;</span>
            <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span><span style="color:#666">(</span>NotFoundException <span style="color:#666">|</span> CannotCompileException <span style="color:#666">|</span> IOException e<span style="color:#666">){</span>
                e<span style="color:#666">.</span><span style="color:#4070a0">printStackTrace</span><span style="color:#666">();</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
        <span style="color:#007020;font-weight:bold">return</span> classfileBuffer<span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>将整个项目打包为 agent.jar 的过程不做太多介绍，详见 <a href="https://github.com/ffutop/http-client-plugin">ffutop/http-client-plugin</a></p>
<p>针对需要劫持的项目，在启动参数中增加 <code>-javaagent:${PATH_TO}/http-client-plugin.jar</code></p>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-category">
              <a href="/categories/%e6%8a%80%e6%9c%af/">
                技术
              </a>
            </div>
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

<div class="releated-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2020-04-11-large-http-header/">HTTP Large Header Fields Problem</a></li>
    
    <li><a href="/posts/2020-06-17-dubbo-telnet/">Dubbo Telnet 调试</a></li>
    
    <li><a href="/posts/2020-02-28-db-transfer-based-on-dns/">基于DNS的数据库切换·事故</a></li>
    
  </ul>
</div>

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/posts/" target="_blank">Posts</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
   
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

 
  </body>
</html>
