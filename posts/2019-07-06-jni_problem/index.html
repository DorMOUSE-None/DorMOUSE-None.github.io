<!DOCTYPE html>
<html lang="zh-cmn-Hans-CN" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    
    <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2019-07-06-jni_problem/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2019-07-06-jni_problem/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.ffutop.com/"
      },
      "articleSection" : "posts",
      "name" : "JNI 引发的堆外内存泄露",
      "headline" : "JNI 引发的堆外内存泄露",
      "description" : "\u003cp\u003e本以为写写异构代码也不算一件难事。毕竟做 Java 开发，日常也写些 C 代码，无论如何也不至于到棘手到地步。哪曾想，JNI 开发不难，但问题颇多。\u003c/p\u003e\n\u003cp\u003e为了排查一个 JNI 的堆外内存泄露问题，简直是绞尽脑汁而不得其门。最后查找的问题原因也特别简单，但凡认真学习了 JNI 开发都能够避免。\u003c/p\u003e\n\u003cp\u003e问题代码类似于下列代码：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan style=\"color:#007020\"\u003e#include\u003c/span\u003e \u003cspan style=\"color:#007020\"\u003e\u0026#34;Main.h\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#007020\"\u003e\n\u003c/span\u003e\u003cspan style=\"color:#007020\"\u003e\u003c/span\u003e\nJNIEXPORT \u003cspan style=\"color:#902000\"\u003evoid\u003c/span\u003e JNICALL \u003cspan style=\"color:#06287e\"\u003eJava_Main_sayHi\u003c/span\u003e (JNIEnv \u003cspan style=\"color:#666\"\u003e*\u003c/span\u003eenv, jobject jobj, jstring jstr)\n{\n    \u003cspan style=\"color:#007020;font-weight:bold\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#902000\"\u003echar\u003c/span\u003e \u003cspan style=\"color:#666\"\u003e*\u003c/span\u003estr \u003cspan style=\"color:#666\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#666\"\u003e*\u003c/span\u003eenv)\u003cspan style=\"color:#666\"\u003e-\u0026gt;\u003c/span\u003eGetStringUTFChars(env, jstr, \u003cspan style=\"color:#40a070\"\u003e0\u003c/span\u003e);\n    \u003cspan style=\"color:#902000\"\u003eint\u003c/span\u003e len \u003cspan style=\"color:#666\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#666\"\u003e*\u003c/span\u003eenv)\u003cspan style=\"color:#666\"\u003e-\u0026gt;\u003c/span\u003eGetStringUTFLength(env, jstr);\n\n    \u003cspan style=\"color:#60a0b0;font-style:italic\"\u003e// ... some code omitted \n\u003c/span\u003e\u003cspan style=\"color:#60a0b0;font-style:italic\"\u003e\u003c/span\u003e\n    \u003cspan style=\"color:#007020;font-weight:bold\"\u003ereturn\u003c/span\u003e ;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2019",
      "datePublished": "2019-07-06T00:00:00Z",
      "dateModified" : "2019-07-06T00:00:00Z",
      "url" : "https://www.ffutop.com/posts/2019-07-06-jni_problem/",
      "keywords" : [ "JNI","memory leak", ]
  }
</script>
<title>JNI 引发的堆外内存泄露</title>
  <meta property="og:title" content="JNI 引发的堆外内存泄露" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="本以为写写异构代码也不算一件难事。毕竟做 Java 开发，日常也写些 C 代码，无论如何也不至于到棘手到地步。哪曾想，JNI 开发不难，但问题颇多。
为了排查一个 JNI 的堆外内存泄露问题，简直是绞尽脑汁而不得其门。最后查找的问题原因也特别简单，但凡认真学习了 JNI 开发都能够避免。
问题代码类似于下列代码：
#include &#34;Main.h&#34;

JNIEXPORT void JNICALL Java_Main_sayHi (JNIEnv *env, jobject jobj, jstring jstr)
{
    const char *str = (*env)-&gt;GetStringUTFChars(env, jstr, 0);
    int len = (*env)-&gt;GetStringUTFLength(env, jstr);

    // ... some code omitted 

    return ;
}
" />
  <meta name="description" content="本以为写写异构代码也不算一件难事。毕竟做 Java 开发，日常也写些 C 代码，无论如何也不至于到棘手到地步。哪曾想，JNI 开发不难，但问题颇多。
为了排查一个 JNI 的堆外内存泄露问题，简直是绞尽脑汁而不得其门。最后查找的问题原因也特别简单，但凡认真学习了 JNI 开发都能够避免。
问题代码类似于下列代码：
#include &#34;Main.h&#34;

JNIEXPORT void JNICALL Java_Main_sayHi (JNIEnv *env, jobject jobj, jstring jstr)
{
    const char *str = (*env)-&gt;GetStringUTFChars(env, jstr, 0);
    int len = (*env)-&gt;GetStringUTFLength(env, jstr);

    // ... some code omitted 

    return ;
}
" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/index.css">

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  
  
</head>

     
  </head>
  <body>
    
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">JNI 引发的堆外内存泄露</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2019-07-06 00:00:00 UTC">
                06 Jul 2019
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <p>本以为写写异构代码也不算一件难事。毕竟做 Java 开发，日常也写些 C 代码，无论如何也不至于到棘手到地步。哪曾想，JNI 开发不难，但问题颇多。</p>
<p>为了排查一个 JNI 的堆外内存泄露问题，简直是绞尽脑汁而不得其门。最后查找的问题原因也特别简单，但凡认真学习了 JNI 开发都能够避免。</p>
<p>问题代码类似于下列代码：</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#007020">#include</span> <span style="color:#007020">&#34;Main.h&#34;</span><span style="color:#007020">
</span><span style="color:#007020"></span>
JNIEXPORT <span style="color:#902000">void</span> JNICALL <span style="color:#06287e">Java_Main_sayHi</span> (JNIEnv <span style="color:#666">*</span>env, jobject jobj, jstring jstr)
{
    <span style="color:#007020;font-weight:bold">const</span> <span style="color:#902000">char</span> <span style="color:#666">*</span>str <span style="color:#666">=</span> (<span style="color:#666">*</span>env)<span style="color:#666">-&gt;</span>GetStringUTFChars(env, jstr, <span style="color:#40a070">0</span>);
    <span style="color:#902000">int</span> len <span style="color:#666">=</span> (<span style="color:#666">*</span>env)<span style="color:#666">-&gt;</span>GetStringUTFLength(env, jstr);

    <span style="color:#60a0b0;font-style:italic">// ... some code omitted 
</span><span style="color:#60a0b0;font-style:italic"></span>
    <span style="color:#007020;font-weight:bold">return</span> ;
}
</code></pre></div><h2 id="问题表现">问题表现</h2>
<p>最初的表现很明显，2核4G的机器，2GB的 Java 堆，最终物理内存不够用，导致 Java 进程被强制杀掉。几乎毫无疑问，就是 Java 堆外内存引发的问题。不过遗憾的是，物理内存不够用，没有留下足够多的堆栈详情。另外找了一台快要把内存打满的机器，打印信息。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ pmap -x <span style="color:#40a070">27765</span> | sort -n -k3 | tail -n <span style="color:#40a070">50</span>
00007f460c9ac000   <span style="color:#40a070">55632</span>   <span style="color:#40a070">23896</span>   <span style="color:#40a070">23896</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45d0000000   <span style="color:#40a070">38980</span>   <span style="color:#40a070">38980</span>   <span style="color:#40a070">38980</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45dc000000   <span style="color:#40a070">45980</span>   <span style="color:#40a070">39512</span>   <span style="color:#40a070">39512</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45e0000000   <span style="color:#40a070">46120</span>   <span style="color:#40a070">39652</span>   <span style="color:#40a070">39652</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45d4000000   <span style="color:#40a070">42160</span>   <span style="color:#40a070">41744</span>   <span style="color:#40a070">41744</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45c8000000   <span style="color:#40a070">45992</span>   <span style="color:#40a070">45992</span>   <span style="color:#40a070">45992</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f4610000000   <span style="color:#40a070">48896</span>   <span style="color:#40a070">48872</span>   <span style="color:#40a070">48872</span> rwx--   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45f8000000   <span style="color:#40a070">51084</span>   <span style="color:#40a070">51084</span>   <span style="color:#40a070">51084</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f4600000000   <span style="color:#40a070">52328</span>   <span style="color:#40a070">52328</span>   <span style="color:#40a070">52328</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f4608000000   <span style="color:#40a070">58332</span>   <span style="color:#40a070">55452</span>   <span style="color:#40a070">55452</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00000000014f8000   <span style="color:#40a070">57036</span>   <span style="color:#40a070">56908</span>   <span style="color:#40a070">56908</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45d8000000   <span style="color:#40a070">63760</span>   <span style="color:#40a070">57292</span>   <span style="color:#40a070">57292</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45e8000000   <span style="color:#40a070">58488</span>   <span style="color:#40a070">58488</span>   <span style="color:#40a070">58488</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f4604000000   <span style="color:#40a070">59912</span>   <span style="color:#40a070">59912</span>   <span style="color:#40a070">59912</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45fc000000   <span style="color:#40a070">60080</span>   <span style="color:#40a070">60080</span>   <span style="color:#40a070">60080</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45e4000000   <span style="color:#40a070">64460</span>   <span style="color:#40a070">64452</span>   <span style="color:#40a070">64452</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f45f4000000   <span style="color:#40a070">65072</span>   <span style="color:#40a070">65072</span>   <span style="color:#40a070">65072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f4620000000   <span style="color:#40a070">65536</span>   <span style="color:#40a070">65536</span>   <span style="color:#40a070">65536</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
<span style="color:#40a070">0000000080000000</span> <span style="color:#40a070">2105600</span> <span style="color:#40a070">2008240</span> <span style="color:#40a070">2008240</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>   <span style="color:#60a0b0;font-style:italic"># 2GB 的 Java 堆</span>
total kB         <span style="color:#40a070">4885820</span> <span style="color:#40a070">3040036</span> <span style="color:#40a070">3030476</span>
</code></pre></div><p>比较多的内存块都在 64M 左右大小。确实也很明显，就是申请的内存没有得到释放。</p>
<h2 id="问题排查">问题排查</h2>
<p>C 不似 Java，没有 Garbage Collection 。所有申请的内存都必须主动进行释放。唯一的问题就是 <code>GetStringUTFChars</code> 得到的内存是否会被 JVM 统一管理。</p>
<p>结果当然是不会，虽然是 Java 与 C 衔接的胶水代码，但这部分得到的内存需要自行管理。不过，JNI 也提供了函数来进行释放。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#60a0b0;font-style:italic">/* from src/share/vm/prims/jni.cpp */</span>
JNI_ENTRY(<span style="color:#007020;font-weight:bold">const</span> <span style="color:#902000">char</span><span style="color:#666">*</span>, jni_GetStringUTFChars(JNIEnv <span style="color:#666">*</span>env, jstring string, jboolean <span style="color:#666">*</span>isCopy))
  JNIWrapper(<span style="color:#4070a0">&#34;GetStringUTFChars&#34;</span>);
  <span style="color:#902000">char</span><span style="color:#666">*</span> result <span style="color:#666">=</span> <span style="color:#007020">NULL</span>;
  oop java_string <span style="color:#666">=</span> JNIHandles<span style="color:#666">::</span>resolve_non_null(string);
  <span style="color:#007020;font-weight:bold">if</span> (java_lang_String<span style="color:#666">::</span>value(java_string) <span style="color:#666">!=</span> <span style="color:#007020">NULL</span>) {
    size_t length <span style="color:#666">=</span> java_lang_String<span style="color:#666">::</span>utf8_length(java_string);
    <span style="color:#60a0b0;font-style:italic">/* 申请堆内存 */</span>
    result <span style="color:#666">=</span> AllocateHeap(length <span style="color:#666">+</span> <span style="color:#40a070">1</span>, mtInternal, <span style="color:#40a070">0</span>, AllocFailStrategy<span style="color:#666">::</span>RETURN_NULL);
    <span style="color:#007020;font-weight:bold">if</span> (result <span style="color:#666">!=</span> <span style="color:#007020">NULL</span>) {
      java_lang_String<span style="color:#666">::</span>as_utf8_string(java_string, result, (<span style="color:#902000">int</span>) length <span style="color:#666">+</span> <span style="color:#40a070">1</span>);
      <span style="color:#007020;font-weight:bold">if</span> (isCopy <span style="color:#666">!=</span> <span style="color:#007020">NULL</span>) {
        <span style="color:#666">*</span>isCopy <span style="color:#666">=</span> JNI_TRUE;
      }
    }
  }
  <span style="color:#007020;font-weight:bold">return</span> result;
JNI_END

<span style="color:#60a0b0;font-style:italic">/* from src/share/vm/memory/allocation.inline.hpp */</span>
<span style="color:#007020;font-weight:bold">inline</span> <span style="color:#902000">char</span><span style="color:#666">*</span> AllocateHeap(size_t size, MEMFLAGS flags,
    <span style="color:#007020;font-weight:bold">const</span> NativeCallStack<span style="color:#666">&amp;</span> stack,
    AllocFailType alloc_failmode <span style="color:#666">=</span> AllocFailStrategy<span style="color:#666">::</span>EXIT_OOM) {
    <span style="color:#60a0b0;font-style:italic">// 申请内存
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#902000">char</span><span style="color:#666">*</span> p <span style="color:#666">=</span> (<span style="color:#902000">char</span><span style="color:#666">*</span>) os<span style="color:#666">::</span>malloc(size, flags, stack);
<span style="color:#007020">#ifdef ASSERT
</span><span style="color:#007020"></span>    <span style="color:#007020;font-weight:bold">if</span> (PrintMallocFree) trace_heap_malloc(size, <span style="color:#4070a0">&#34;AllocateHeap&#34;</span>, p);
<span style="color:#007020">#endif
</span><span style="color:#007020"></span>    <span style="color:#007020;font-weight:bold">if</span> (p <span style="color:#666">==</span> <span style="color:#007020">NULL</span> <span style="color:#666">&amp;&amp;</span> alloc_failmode <span style="color:#666">==</span> AllocFailStrategy<span style="color:#666">::</span>EXIT_OOM) {
        vm_exit_out_of_memory(size, OOM_MALLOC_ERROR, <span style="color:#4070a0">&#34;AllocateHeap&#34;</span>);
    }
    <span style="color:#007020;font-weight:bold">return</span> p;
}

<span style="color:#60a0b0;font-style:italic">/* from src/share/vm/prims/jni.cpp */</span>
JNI_LEAF(<span style="color:#902000">void</span>, jni_ReleaseStringUTFChars(JNIEnv <span style="color:#666">*</span>env, jstring str, <span style="color:#007020;font-weight:bold">const</span> <span style="color:#902000">char</span> <span style="color:#666">*</span>chars))
  JNIWrapper(<span style="color:#4070a0">&#34;ReleaseStringUTFChars&#34;</span>);
  <span style="color:#007020;font-weight:bold">if</span> (chars <span style="color:#666">!=</span> <span style="color:#007020">NULL</span>) {
    <span style="color:#60a0b0;font-style:italic">// 释放内存
</span><span style="color:#60a0b0;font-style:italic"></span>    FreeHeap((<span style="color:#902000">char</span><span style="color:#666">*</span>) chars);
  }
);
JNI_END

<span style="color:#60a0b0;font-style:italic">/* from src/share/vm/memory/allocation.inline.hpp */</span>
<span style="color:#007020;font-weight:bold">inline</span> <span style="color:#902000">void</span> FreeHeap(<span style="color:#902000">void</span><span style="color:#666">*</span> p, MEMFLAGS memflags <span style="color:#666">=</span> mtInternal) {
<span style="color:#007020">#ifdef ASSERT
</span><span style="color:#007020"></span>    <span style="color:#007020;font-weight:bold">if</span> (PrintMallocFree) trace_heap_free(p);
<span style="color:#007020">#endif
</span><span style="color:#007020"></span>    os<span style="color:#666">::</span>free(p, memflags);
}
</code></pre></div><p>从名称就可以看出来，<code>GetStringUTFChars</code> 和 <code>ReleaseStringUTFChars</code> 是相对的方法。而且默认走的都是 Glibc 的 <code>malloc</code> 和 <code>free</code> 。</p>
<h2 id="问题验证">问题验证</h2>
<p>为了验证问题的原因和最终的现象，整了一段代码来测试效果。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">java.io.IOException</span><span style="color:#666">;</span>

<span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Main</span> <span style="color:#666">{</span>

    <span style="color:#007020;font-weight:bold">static</span> <span style="color:#666">{</span>
        System<span style="color:#666">.</span><span style="color:#4070a0">load</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;/root/jni/Main.so&#34;</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">final</span> String value <span style="color:#666">=</span> <span style="color:#4070a0">&#34;AAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHH&#34;</span><span style="color:#666">;</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">native</span> <span style="color:#902000">void</span> <span style="color:#06287e">sayHi</span><span style="color:#666">(</span>String value<span style="color:#666">);</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> IOException <span style="color:#666">{</span>
        Main main <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Main<span style="color:#666">();</span>
        <span style="color:#007020;font-weight:bold">while</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">true</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#902000">int</span> i<span style="color:#666">=</span>0<span style="color:#666">;</span>i<span style="color:#666">&lt;</span>100000<span style="color:#666">;</span>i<span style="color:#666">++)</span> <span style="color:#666">{</span>
                <span style="color:#902000">char</span> c1 <span style="color:#666">=</span> <span style="color:#666">(</span><span style="color:#902000">char</span><span style="color:#666">)</span> <span style="color:#666">(</span><span style="color:#4070a0">&#39;A&#39;</span> <span style="color:#666">+</span> Math<span style="color:#666">.</span><span style="color:#4070a0">random</span><span style="color:#666">()</span> <span style="color:#666">*</span> 26<span style="color:#666">);</span>
                <span style="color:#902000">char</span> c2 <span style="color:#666">=</span> <span style="color:#666">(</span><span style="color:#902000">char</span><span style="color:#666">)</span> <span style="color:#666">(</span><span style="color:#4070a0">&#39;a&#39;</span> <span style="color:#666">+</span> Math<span style="color:#666">.</span><span style="color:#4070a0">random</span><span style="color:#666">()</span> <span style="color:#666">*</span> 26<span style="color:#666">);</span>
                main<span style="color:#666">.</span><span style="color:#4070a0">sayHi</span><span style="color:#666">(</span>value <span style="color:#666">+</span> c1 <span style="color:#666">+</span> c2<span style="color:#666">);</span>
            <span style="color:#666">}</span>
            System<span style="color:#666">.</span><span style="color:#4070a0">gc</span><span style="color:#666">();</span>
            <span style="color:#902000">int</span> val <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">in</span><span style="color:#666">.</span><span style="color:#4070a0">read</span><span style="color:#666">();</span>
            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>val <span style="color:#666">==</span> <span style="color:#4070a0">&#39;1&#39;</span><span style="color:#666">)</span>
                <span style="color:#007020;font-weight:bold">break</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#007020">#include</span> <span style="color:#007020">&#34;Main.h&#34;</span><span style="color:#007020">
</span><span style="color:#007020"></span>
JNIEXPORT <span style="color:#902000">void</span> JNICALL <span style="color:#06287e">Java_Main_sayHi</span> (JNIEnv <span style="color:#666">*</span>env, jobject jobj, jstring jstr)
{
    <span style="color:#007020;font-weight:bold">const</span> <span style="color:#902000">char</span> <span style="color:#666">*</span>str <span style="color:#666">=</span> (<span style="color:#666">*</span>env)<span style="color:#666">-&gt;</span>GetStringUTFChars(env, jstr, <span style="color:#40a070">0</span>);
    <span style="color:#902000">int</span> len <span style="color:#666">=</span> (<span style="color:#666">*</span>env)<span style="color:#666">-&gt;</span>GetStringUTFLength(env, jstr);
    printf(<span style="color:#4070a0">&#34;%p</span><span style="color:#4070a0;font-weight:bold">\n</span><span style="color:#4070a0">&#34;</span>, str);
<span style="color:#007020">#ifdef SUCCESS
</span><span style="color:#007020"></span>    (<span style="color:#666">*</span>env)<span style="color:#666">-&gt;</span>ReleaseStringUTFChars(env, jstr, str);
<span style="color:#007020">#endif
</span><span style="color:#007020"></span>    <span style="color:#007020;font-weight:bold">return</span> ;
}
</code></pre></div><p><a href="https://raw.githubusercontent.com/DorMOUSE-None/Repo/master/jni-memory-leak.zip">测试用的源代码</a></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ java Main
$ pmap -x <span style="color:#40a070">22690</span> | sort -n -k3
<span style="color:#60a0b0;font-style:italic"># ...</span>
00007f0d44000000   <span style="color:#40a070">65536</span>   <span style="color:#40a070">65500</span>   <span style="color:#40a070">65500</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0d04000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131068</span>  <span style="color:#40a070">131068</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0cc4000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0ccc000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0cd4000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0cdc000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0ce4000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0cec000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0cf4000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
00007f0cfc000000  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span>  <span style="color:#40a070">131072</span> rw---   <span style="color:#666">[</span> anon <span style="color:#666">]</span>
total kB         <span style="color:#40a070">3822700</span> <span style="color:#40a070">1293952</span> <span style="color:#40a070">1276900</span> 
</code></pre></div><p>确实引起了内存的增长，而将内存 dump 下了之后，也看到了大量字符串。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ <span style="color:#bb60d5">PID</span><span style="color:#666">=</span>23756; grep rw-p /proc/<span style="color:#70a0d0;font-style:italic">${</span><span style="color:#bb60d5">PID</span><span style="color:#70a0d0;font-style:italic">}</span>/maps | sed -n <span style="color:#4070a0">&#39;s/^\([0-9a-f]*\)-\([0-9a-f]*\) .*$/\1 \2/p&#39;</span> | <span style="color:#007020;font-weight:bold">while</span> <span style="color:#007020">read</span> start stop;  <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span><span style="color:#007020;font-weight:bold">do</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>    gdb --batch --pid <span style="color:#70a0d0;font-style:italic">${</span><span style="color:#bb60d5">PID</span><span style="color:#70a0d0;font-style:italic">}</span> -ex <span style="color:#4070a0">&#34;dump memory </span><span style="color:#70a0d0;font-style:italic">${</span><span style="color:#bb60d5">PID</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">-</span><span style="color:#bb60d5">$start</span><span style="color:#4070a0">-</span><span style="color:#bb60d5">$stop</span><span style="color:#4070a0">.dump 0x</span><span style="color:#bb60d5">$start</span><span style="color:#4070a0"> 0x</span><span style="color:#bb60d5">$stop</span><span style="color:#4070a0">&#34;</span>;  <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span><span style="color:#007020;font-weight:bold">done</span> 
$ strings 23756-7f6f6c000000-7f6f70000000.dump| grep <span style="color:#4070a0">&#39;AAAA&#39;</span>
<span style="color:#60a0b0;font-style:italic"># ...</span>
AAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHVn
AAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHXp
AAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHAAAAABBBBBCCCCCDDDDDEEEEEGGGGGHHHHHFn
</code></pre></div><p>待到添加上 <code>ReleaseStringUTFChars</code> ，申请到内存得到释放，确实解决了这个问题。</p>
<h2 id="总结">总结</h2>
<p>定位问题确实看起来不难，但这种异构代码，真正难点在于定位问题。这期间走了不少的弯路，也无法确定究竟是对是错。毕竟问题的原因多种多样：</p>
<ol>
<li>可能是 Java 代码用了诸如 Zip 等容易出现堆外内存泄露的方法</li>
<li>不当使用 JNI （就像是上文描述的问题）</li>
<li>再有就是第三方 C 库使用不当，或者其本身存在 BUG。</li>
</ol>
<p>这是第一次排查异构代码的问题，颇多难以分辨，无法做定论之事。</p>
<p>再就是 C 的平台相关性实在是太过于严重了，加之本就不太熟悉，搞个编译新的库文件就好一番折腾。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-category">
              <a href="/categories/%e6%8a%80%e6%9c%af/">
                技术
              </a>
            </div>
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/posts/" target="_blank">Posts</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
   
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

 
  </body>
</html>
