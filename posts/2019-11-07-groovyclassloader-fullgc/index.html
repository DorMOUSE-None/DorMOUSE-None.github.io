<!DOCTYPE html>
<html lang="zh-cn">
<head>
  
    <title>GroovyClassLoader 引发的 FullGC :: Utop&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="背景 近日，一个线上应用的存活探针频繁报警。几分钟内 Full GC 次数暴涨上百次，stop the world :&amp;lt; 从 gc.log 中，看到的原因是触及了 Metaspace 的阈值，进而引发了 FGC。
2019-11-05T14:31:38.880&#43;0800: 504600.716: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:38.880&#43;0800: 504600.716: [CMS2019-11-05T14:31:39.364&#43;0800: 504601.201: [CMS-concurrent-mark: 0.485/0.488 secs] [Times: user=0.48 sys=0.00, real=0.49 secs] (concurrent mode failure): 266828K-&amp;gt;266865K(873856K), 1.3752377 secs] 267430K-&amp;gt;266865K(1267072K), [Metaspace: 204152K-&amp;gt;204152K(1267712K)], 1.3757441 secs] [Times: user=1.36 sys=0.00, real=1.38 secs] 2019-11-05T14:31:40.256&#43;0800: 504602.092: [Full GC (Last ditch collection) 2019-11-05T14:31:40.256&#43;0800: 504602.092: [CMS: 266865K-&amp;gt;266841K(873856K), 0.8590901 secs] 266865K-&amp;gt;266841K(1267072K), [Metaspace: 204152K-&amp;gt;204152K(1267712K)], 0.8595047 secs] [Times: user=0.86 sys=0.00, real=0.86 secs] 2019-11-05T14:31:41.117&#43;0800: 504602.953: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:41.117&#43;0800: 504602.953: [CMS: 266841K-&amp;gt;266816K(873856K), 0.9109948 secs] 267218K-&amp;gt;266816K(1267072K), [Metaspace: 204153K-&amp;gt;204153K(1267712K)], 0.9114975 secs] [Times: user=0.91 sys=0.00, real=0.91 secs] 2019-11-05T14:31:42.028&#43;0800: 504603.865: [Full GC (Last ditch collection) 2019-11-05T14:31:42.028&#43;0800: 504603.865: [CMS: 266816K-&amp;gt;266769K(873856K), 1.0351283 secs] 266816K-&amp;gt;266769K(1267072K), [Metaspace: 204153K-&amp;gt;204153K(1267712K)], 1.0355630 secs] [Times: user=0.92 sys=0.00, real=1.04 secs]  FGC 前后，Metaspace 占用的内存没有得到任何释放。[Metaspace: 204153K-&amp;gt;204153K(1267712K)] 。这也就是反复 FGC 的原因。
"/>
<meta name="keywords" content="BLOG"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://www.ffutop.com/posts/2019-11-07-groovyclassloader-fullgc/" />


<link rel="stylesheet" href="https://www.ffutop.com/assets/style.css">

  <link rel="stylesheet" href="https://www.ffutop.com/assets/blue.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.ffutop.com/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="https://www.ffutop.com/favicon.ico">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="GroovyClassLoader 引发的 FullGC :: Utop&#39;s Blog — " />
<meta name="twitter:description" content="背景 近日，一个线上应用的存活探针频繁报警。几分钟内 Full GC 次数暴涨上百次，stop the world :&amp;lt; 从 gc.log 中，看到的原因是触及了 Metaspace 的阈值，进而引发了 FGC。
2019-11-05T14:31:38.880&#43;0800: 504600.716: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:38.880&#43;0800: 504600.716: [CMS2019-11-05T14:31:39.364&#43;0800: 504601.201: [CMS-concurrent-mark: 0.485/0.488 secs] [Times: user=0.48 sys=0.00, real=0.49 secs] (concurrent mode failure): 266828K-&amp;gt;266865K(873856K), 1.3752377 secs] 267430K-&amp;gt;266865K(1267072K), [Metaspace: 204152K-&amp;gt;204152K(1267712K)], 1.3757441 secs] [Times: user=1.36 sys=0.00, real=1.38 secs] 2019-11-05T14:31:40.256&#43;0800: 504602.092: [Full GC (Last ditch collection) 2019-11-05T14:31:40.256&#43;0800: 504602.092: [CMS: 266865K-&amp;gt;266841K(873856K), 0.8590901 secs] 266865K-&amp;gt;266841K(1267072K), [Metaspace: 204152K-&amp;gt;204152K(1267712K)], 0.8595047 secs] [Times: user=0.86 sys=0.00, real=0.86 secs] 2019-11-05T14:31:41.117&#43;0800: 504602.953: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:41.117&#43;0800: 504602.953: [CMS: 266841K-&amp;gt;266816K(873856K), 0.9109948 secs] 267218K-&amp;gt;266816K(1267072K), [Metaspace: 204153K-&amp;gt;204153K(1267712K)], 0.9114975 secs] [Times: user=0.91 sys=0.00, real=0.91 secs] 2019-11-05T14:31:42.028&#43;0800: 504603.865: [Full GC (Last ditch collection) 2019-11-05T14:31:42.028&#43;0800: 504603.865: [CMS: 266816K-&amp;gt;266769K(873856K), 1.0351283 secs] 266816K-&amp;gt;266769K(1267072K), [Metaspace: 204153K-&amp;gt;204153K(1267712K)], 1.0355630 secs] [Times: user=0.92 sys=0.00, real=1.04 secs]  FGC 前后，Metaspace 占用的内存没有得到任何释放。[Metaspace: 204153K-&amp;gt;204153K(1267712K)] 。这也就是反复 FGC 的原因。
" />
<meta name="twitter:site" content="https://www.ffutop.com/" />
<meta name="twitter:creator" content="fangfeng" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="zh-cn" />
<meta property="og:type" content="article" />
<meta property="og:title" content="GroovyClassLoader 引发的 FullGC :: Utop&#39;s Blog — ">
<meta property="og:description" content="背景 近日，一个线上应用的存活探针频繁报警。几分钟内 Full GC 次数暴涨上百次，stop the world :&amp;lt; 从 gc.log 中，看到的原因是触及了 Metaspace 的阈值，进而引发了 FGC。
2019-11-05T14:31:38.880&#43;0800: 504600.716: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:38.880&#43;0800: 504600.716: [CMS2019-11-05T14:31:39.364&#43;0800: 504601.201: [CMS-concurrent-mark: 0.485/0.488 secs] [Times: user=0.48 sys=0.00, real=0.49 secs] (concurrent mode failure): 266828K-&amp;gt;266865K(873856K), 1.3752377 secs] 267430K-&amp;gt;266865K(1267072K), [Metaspace: 204152K-&amp;gt;204152K(1267712K)], 1.3757441 secs] [Times: user=1.36 sys=0.00, real=1.38 secs] 2019-11-05T14:31:40.256&#43;0800: 504602.092: [Full GC (Last ditch collection) 2019-11-05T14:31:40.256&#43;0800: 504602.092: [CMS: 266865K-&amp;gt;266841K(873856K), 0.8590901 secs] 266865K-&amp;gt;266841K(1267072K), [Metaspace: 204152K-&amp;gt;204152K(1267712K)], 0.8595047 secs] [Times: user=0.86 sys=0.00, real=0.86 secs] 2019-11-05T14:31:41.117&#43;0800: 504602.953: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:41.117&#43;0800: 504602.953: [CMS: 266841K-&amp;gt;266816K(873856K), 0.9109948 secs] 267218K-&amp;gt;266816K(1267072K), [Metaspace: 204153K-&amp;gt;204153K(1267712K)], 0.9114975 secs] [Times: user=0.91 sys=0.00, real=0.91 secs] 2019-11-05T14:31:42.028&#43;0800: 504603.865: [Full GC (Last ditch collection) 2019-11-05T14:31:42.028&#43;0800: 504603.865: [CMS: 266816K-&amp;gt;266769K(873856K), 1.0351283 secs] 266816K-&amp;gt;266769K(1267072K), [Metaspace: 204153K-&amp;gt;204153K(1267712K)], 1.0355630 secs] [Times: user=0.92 sys=0.00, real=1.04 secs]  FGC 前后，Metaspace 占用的内存没有得到任何释放。[Metaspace: 204153K-&amp;gt;204153K(1267712K)] 。这也就是反复 FGC 的原因。
" />
<meta property="og:url" content="https://www.ffutop.com/posts/2019-11-07-groovyclassloader-fullgc/" />
<meta property="og:site_name" content="GroovyClassLoader 引发的 FullGC" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-11-06 00:00:00 &#43;0000 UTC" />










<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92258941-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', "UA-92258941-1");
</script>



</head>
<body class="">


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    ffutop
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">关于</a></li>
        
      
        
          <li><a href="/archives">归档</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">关于</a></li>
      
    
      
        <li><a href="/archives">归档</a></li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://www.ffutop.com/posts/2019-11-07-groovyclassloader-fullgc/">GroovyClassLoader 引发的 FullGC</a></h1>
  <div class="post-meta">
      
    <span class="post-date">
      2019-11-06
    </span>
    
    
    <span class="post-author">::
      fangfeng
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://www.ffutop.com/tags/groovy/">Groovy</a>&nbsp;
    
    #<a href="https://www.ffutop.com/tags/java/">Java</a>&nbsp;
    
    #<a href="https://www.ffutop.com/tags/fullgc/">FullGC</a>&nbsp;
    
    #<a href="https://www.ffutop.com/tags/gc/">GC</a>&nbsp;
    
    #<a href="https://www.ffutop.com/tags/metaspace/">Metaspace</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    <h2 id="背景">背景</h2>

<p>近日，一个线上应用的存活探针频繁报警。几分钟内 Full GC 次数暴涨上百次，<strong>stop the world</strong> :&lt; 从 <code>gc.log</code> 中，看到的原因是触及了 <code>Metaspace</code> 的阈值，进而引发了 FGC。</p>

<pre><code class="language-plain">2019-11-05T14:31:38.880+0800: 504600.716: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:38.880+0800: 504600.716: [CMS2019-11-05T14:31:39.364+0800: 504601.201: [CMS-concurrent-mark: 0.485/0.488 secs] [Times: user=0.48 sys=0.00, real=0.49 secs]
 (concurrent mode failure): 266828K-&gt;266865K(873856K), 1.3752377 secs] 267430K-&gt;266865K(1267072K), [Metaspace: 204152K-&gt;204152K(1267712K)], 1.3757441 secs] [Times: user=1.36 sys=0.00, real=1.38 secs]
2019-11-05T14:31:40.256+0800: 504602.092: [Full GC (Last ditch collection) 2019-11-05T14:31:40.256+0800: 504602.092: [CMS: 266865K-&gt;266841K(873856K), 0.8590901 secs] 266865K-&gt;266841K(1267072K), [Metaspace: 204152K-&gt;204152K(1267712K)], 0.8595047 secs] [Times: user=0.86 sys=0.00, real=0.86 secs]
2019-11-05T14:31:41.117+0800: 504602.953: [Full GC (Metadata GC Threshold) 2019-11-05T14:31:41.117+0800: 504602.953: [CMS: 266841K-&gt;266816K(873856K), 0.9109948 secs] 267218K-&gt;266816K(1267072K), [Metaspace: 204153K-&gt;204153K(1267712K)], 0.9114975 secs] [Times: user=0.91 sys=0.00, real=0.91 secs]
2019-11-05T14:31:42.028+0800: 504603.865: [Full GC (Last ditch collection) 2019-11-05T14:31:42.028+0800: 504603.865: [CMS: 266816K-&gt;266769K(873856K), 1.0351283 secs] 266816K-&gt;266769K(1267072K), [Metaspace: 204153K-&gt;204153K(1267712K)], 1.0355630 secs] [Times: user=0.92 sys=0.00, real=1.04 secs]
</code></pre>

<p>FGC 前后，<code>Metaspace</code> 占用的内存没有得到任何释放。<em>[Metaspace: 204153K-&gt;204153K(1267712K)]</em> 。这也就是反复 FGC 的原因。</p>

<h2 id="问题排查">问题排查</h2>

<p>由于这个问题是近期第二次出现，项目代码已经跑了好几年。从最近的 Git 提交记录入手，找到了很重要的变更记录——开始启动 4 年不曾真正动用的 <code>GroovyClassLoader</code> 。用以支持在 Java 项目中的动态脚本。没曾想这就是噩梦的开始&hellip;</p>

<p>通过 MAT 分析 Java 堆，泄露分析报告给到的三个可能的问题都很简单地排除了。由于经验的缺失，排除了占用大块内存的类实例之后，就直接放弃了这条路（后来发现分析零散的类，就可以直接定位问题了:&lt;）</p>

<p>抽取了一些核心的代码，大体上就是下面这三个类啦。</p>

<p><strong>Loader.java</strong></p>

<pre><code class="language-java">package com.ffutop.loader;

import com.ffutop.api.Action;
import groovy.lang.GroovyClassLoader;

import java.util.HashMap;
import java.util.Map;

/**
 * @author fangfeng
 * @since 2019/11/6
 */
public class Loader {

    private static final String printScript = &quot;import com.ffutop.api.Action; public class HelloAction implements Action { public void print() { System.out.println(\&quot;Hello, World.\&quot;); }}&quot;;

    public Map&lt;String, Action&gt; loadScript() throws IllegalAccessException, InstantiationException {
        Map&lt;String, Action&gt; map = new HashMap&lt;String, Action&gt;();
        GroovyClassLoader groovyClassLoader = new GroovyClassLoader();
        Class clazz = groovyClassLoader.parseClass(printScript);
        Action action = (Action) clazz.newInstance();
        map.put(&quot;HelloAction&quot;, action);
        return map;
    }
}
</code></pre>

<p><strong>Action.java</strong></p>

<pre><code class="language-java">package com.ffutop.api;

/**
 * @author fangfeng
 * @since 2019/11/6
 */
public interface Action {
    void print();
}
</code></pre>

<p><strong>Main.java</strong></p>

<p><em>在项目中，这个 Main 其实是一个定时任务，定期去数据库抓取的 Groovy 脚本，完成编译并做缓存（请先忽略这个做法的合理性）</em></p>

<pre><code class="language-java">package com.ffutop;

import com.ffutop.api.Action;
import com.ffutop.loader.Loader;

import java.io.IOException;
import java.util.Map;

/**
 * @author fangfeng
 * @since 2019/11/6
 */
public class Main {
    public static void main(String[] args) throws InstantiationException, IllegalAccessException, IOException {
        Loader loader = new Loader();
        for (int i=0;i&lt;1000000;i++) {
            Map&lt;String, Action&gt; map = loader.loadScript();
            Action action = map.get(&quot;HelloAction&quot;);
            action.print();
        }
        System.in.read();
    }
}
</code></pre>

<p>很遗憾，问题的根源在于 Maven 引入的 groovy 库的版本，用 2.5.7 版本反复调试了一天都没有复现，最后才从版本入手成功复现 （Version &lt;= 2.4.7）。</p>

<h2 id="追根溯源">追根溯源</h2>

<p>回过头来再审视了一遍 dump 下来的 Java 堆。从 <em>duplicate_classes</em> 也进一步证实了上面猜测的原因。</p>

<p><img src="http://img.ffutop.com/11FB209B-8635-4ACC-8812-A0BA6133376F.png" alt="" /></p>

<p>每次加载的脚本都被认为是各不相同的类，并在加载的同时被 Groovy 全局的 ClassInfo 做了缓存。</p>

<p><img src="http://img.ffutop.com/FB6CA0BF-992E-4199-BF57-35C31D6D3C51.png" alt="" /></p>

<p>至于为何 &gt;= 2.4.8 版本的 groovy 没有问题，代码出现了重要变更。<code>klass</code> 由 <code>StrongReference</code> 变成了 <code>WeakReference</code> 。因此，也就能够保证在 GC 时回收这个引用。</p>

<p><img src="http://img.ffutop.com/9F91AA9F-BAB4-47C3-B8CE-DC8AFEE5480A.png" alt="" /></p>

<p>进一步的，Metaspace 存储的类的元数据信息，从收集到的信息来说，需要满足下列三个条件，才会被回收（未经考证）：</p>

<ol>
<li><p>该类所有的实例都已经被回收</p></li>

<li><p>加载该类的 ClassLoader 已经被回收</p></li>

<li><p>该类对应的 java.lang.Class 对象没有任何地方被引用</p></li>
</ol>

<p>而移除 <code>ClassInfo.klass</code> 下的引用，按照分析也就是阻止元数据被回收的最后一道关卡。</p>

<h2 id="处理方案">处理方案</h2>

<p>最后的处理方案也相当简单，由于不想直接对代码逻辑动刀，升级 <code>groovy-all.jar</code> 的版本是最简单有效的。</p>

<p>附上升级版本后的 Metaspace 使用情况。</p>

<p><img src="http://img.ffutop.com/944505AE-582A-4D25-80CC-F008E5DD1ECF.png" alt="optimized" /></p>

<h2 id="参考">参考</h2>

<p>[1]. <a href="http://lovestblog.cn/blog/2016/10/29/metaspace/">JVM源码分析之Metaspace解密</a>
[2]. <a href="https://issues.apache.org/jira/browse/GROOVY-7683?focusedCommentId=15066871&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-15066871">GROOVY-7683</a></p>
  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://www.ffutop.com/posts/2019-12-14-https/">
          <span class="button__icon">←</span>
          <span class="button__text">HTTPS 安全通讯如何上演？</span>
        </a>
      </span>
      
      
      <span class="button next">
        <a href="https://www.ffutop.com/posts/2019-10-17-random/">
          <span class="button__text">随机数生成器拖慢 Tomcat 启动速度</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>2018-2020 © ffutop</span>
        <span>:: Powered by <a href="http://gohugo.io">Hugo</a></span>
      </div>
    
  </div>
</footer>

<script src="https://www.ffutop.com/assets/main.js"></script>
<script src="https://www.ffutop.com/assets/prism.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
    processEscapes: true
  }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>






  
</div>

</body>
</html>
