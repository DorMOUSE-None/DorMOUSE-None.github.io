<!DOCTYPE html>
<html lang="zh-cmn-Hans-CN" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    
    <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2018-08-15-java-instrumentation/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2018-08-15-java-instrumentation/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.ffutop.com/"
      },
      "articleSection" : "posts",
      "name" : "Java Instrumentation",
      "headline" : "Java Instrumentation",
      "description" : "\u003ch2 id=\"start\"\u003eStart\u003c/h2\u003e\n\u003cp\u003e从现有的前置知识来说，我们能够认识到两个事实:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eJava Class 通过 ClassLoader 进行加载。\n通过\u003ccode\u003e全限定名\u003c/code\u003e进行区分。当需要加载新的类时，ClassLoader 通过双亲委派机制判断是否已经加载过这个类。\n换句话说: Class 一经加载，就不会尝试重复加载 (至少按绝大多数人的认知来说，确实是的)\u003c/li\u003e\n\u003cli\u003e有没有可能让被加载的 Class 与物理存储上的 .class 内容不同。\n当然也是完全可以做到的。不管怎么说，CGlib 和 Java Proxy 也是一个耳熟能详的概念吧\n(虽然可能不了解细节。在此，欢迎学习前置技能 \u003ca href=\"https://dormouse-none.github.io/2018-07-10-CGlib-Enhancer/\"\u003eCGlib Enhancer 主流程源码解析\u003c/a\u003e 和 \u003ca href=\"https://dormouse-none.github.io/2018-07-20-Java-Proxy/\"\u003eJava Proxy 源码解析\u003c/a\u003e。不过不影响本文后续内容)\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e另一个方面，也许绝大多数人都听说过所谓的\u003ccode\u003e热部署\u003c/code\u003e。但是究竟怎么才能做到 \u003ccode\u003e热部署\u003c/code\u003e(话题开得有点大哈。Y_Y 本文不讲这个)\u003c/p\u003e\n\u003cp\u003e操作字节码一定是一个逃不开的话题，毕竟 Class 就是所谓的被加载到内存的字节码嘛。\u003c/p\u003e\n\u003cp\u003e如何操作字节码? ASM, CGlib, Java Proxy, Javassist ? 不过这些都要等到需要被操作的类被加载了才行啊，似乎有点晚\u0026hellip;\u003c/p\u003e\n\u003cp\u003eJava 提供了一个可行的机制，用来在 ClassLoader 加载字节码之前完成对操作字节码的目的\u003c/p\u003e\n\u003ch2 id=\"instrumentation\"\u003eInstrumentation\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003ejava.lang.instrument.Instrumentation\u003c/code\u003e 类为提供直接操作 Java 字节码的又一个途径(虽然 Java Doc 的说明是用来检测 Java 代码的)\u003c/p\u003e\n\u003cp\u003e相信我这个说明是没有问题的。毕竟完成对代码检测的途径是直接修改字节码。\u003c/p\u003e\n\u003cp\u003e下列有两种方法可以达到目的\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e当 JVM 以指示一个代理类的方式启动时，将传递给代理类的 premain 方法一个 Instrumentation 实例。\u003c/li\u003e\n\u003cli\u003e当 JVM 提供某种机制在 JVM 启动之后某一时刻启动代理时，将传递给代理代码的 agentmain 方法一个 Instrumentation 实例。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e话不多说，下面将全部以实例来展现对这种 JVM 检测机制(虽然例子已经脱离了\u003cem\u003e检测\u003c/em\u003e的目的)的使用\u003c/p\u003e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2018",
      "datePublished": "2018-08-15T00:00:00Z",
      "dateModified" : "2018-08-15T00:00:00Z",
      "url" : "https://www.ffutop.com/posts/2018-08-15-java-instrumentation/",
      "keywords" : [ "Java","ASM","BTrace", ]
  }
</script>
<title>Java Instrumentation - Utop&#39;s Blog</title>
  <meta property="og:title" content="Java Instrumentation - Utop&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="Start
从现有的前置知识来说，我们能够认识到两个事实:

Java Class 通过 ClassLoader 进行加载。
通过全限定名进行区分。当需要加载新的类时，ClassLoader 通过双亲委派机制判断是否已经加载过这个类。
换句话说: Class 一经加载，就不会尝试重复加载 (至少按绝大多数人的认知来说，确实是的)
有没有可能让被加载的 Class 与物理存储上的 .class 内容不同。
当然也是完全可以做到的。不管怎么说，CGlib 和 Java Proxy 也是一个耳熟能详的概念吧
(虽然可能不了解细节。在此，欢迎学习前置技能 CGlib Enhancer 主流程源码解析 和 Java Proxy 源码解析。不过不影响本文后续内容)

另一个方面，也许绝大多数人都听说过所谓的热部署。但是究竟怎么才能做到 热部署(话题开得有点大哈。Y_Y 本文不讲这个)
操作字节码一定是一个逃不开的话题，毕竟 Class 就是所谓的被加载到内存的字节码嘛。
如何操作字节码? ASM, CGlib, Java Proxy, Javassist ? 不过这些都要等到需要被操作的类被加载了才行啊，似乎有点晚&hellip;
Java 提供了一个可行的机制，用来在 ClassLoader 加载字节码之前完成对操作字节码的目的
Instrumentation
java.lang.instrument.Instrumentation 类为提供直接操作 Java 字节码的又一个途径(虽然 Java Doc 的说明是用来检测 Java 代码的)
相信我这个说明是没有问题的。毕竟完成对代码检测的途径是直接修改字节码。
下列有两种方法可以达到目的

当 JVM 以指示一个代理类的方式启动时，将传递给代理类的 premain 方法一个 Instrumentation 实例。
当 JVM 提供某种机制在 JVM 启动之后某一时刻启动代理时，将传递给代理代码的 agentmain 方法一个 Instrumentation 实例。

话不多说，下面将全部以实例来展现对这种 JVM 检测机制(虽然例子已经脱离了检测的目的)的使用" />
  <meta name="description" content="Start
从现有的前置知识来说，我们能够认识到两个事实:

Java Class 通过 ClassLoader 进行加载。
通过全限定名进行区分。当需要加载新的类时，ClassLoader 通过双亲委派机制判断是否已经加载过这个类。
换句话说: Class 一经加载，就不会尝试重复加载 (至少按绝大多数人的认知来说，确实是的)
有没有可能让被加载的 Class 与物理存储上的 .class 内容不同。
当然也是完全可以做到的。不管怎么说，CGlib 和 Java Proxy 也是一个耳熟能详的概念吧
(虽然可能不了解细节。在此，欢迎学习前置技能 CGlib Enhancer 主流程源码解析 和 Java Proxy 源码解析。不过不影响本文后续内容)

另一个方面，也许绝大多数人都听说过所谓的热部署。但是究竟怎么才能做到 热部署(话题开得有点大哈。Y_Y 本文不讲这个)
操作字节码一定是一个逃不开的话题，毕竟 Class 就是所谓的被加载到内存的字节码嘛。
如何操作字节码? ASM, CGlib, Java Proxy, Javassist ? 不过这些都要等到需要被操作的类被加载了才行啊，似乎有点晚&hellip;
Java 提供了一个可行的机制，用来在 ClassLoader 加载字节码之前完成对操作字节码的目的
Instrumentation
java.lang.instrument.Instrumentation 类为提供直接操作 Java 字节码的又一个途径(虽然 Java Doc 的说明是用来检测 Java 代码的)
相信我这个说明是没有问题的。毕竟完成对代码检测的途径是直接修改字节码。
下列有两种方法可以达到目的

当 JVM 以指示一个代理类的方式启动时，将传递给代理类的 premain 方法一个 Instrumentation 实例。
当 JVM 提供某种机制在 JVM 启动之后某一时刻启动代理时，将传递给代理代码的 agentmain 方法一个 Instrumentation 实例。

话不多说，下面将全部以实例来展现对这种 JVM 检测机制(虽然例子已经脱离了检测的目的)的使用" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/github-markdown.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-92258941-1"></script>
</head>

     
  </head>
  <body>
    
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">Java Instrumentation</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2018-08-15 00:00:00 UTC">
                15 Aug 2018
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="start">Start</h2>
<p>从现有的前置知识来说，我们能够认识到两个事实:</p>
<ol>
<li>Java Class 通过 ClassLoader 进行加载。
通过<code>全限定名</code>进行区分。当需要加载新的类时，ClassLoader 通过双亲委派机制判断是否已经加载过这个类。
换句话说: Class 一经加载，就不会尝试重复加载 (至少按绝大多数人的认知来说，确实是的)</li>
<li>有没有可能让被加载的 Class 与物理存储上的 .class 内容不同。
当然也是完全可以做到的。不管怎么说，CGlib 和 Java Proxy 也是一个耳熟能详的概念吧
(虽然可能不了解细节。在此，欢迎学习前置技能 <a href="https://dormouse-none.github.io/2018-07-10-CGlib-Enhancer/">CGlib Enhancer 主流程源码解析</a> 和 <a href="https://dormouse-none.github.io/2018-07-20-Java-Proxy/">Java Proxy 源码解析</a>。不过不影响本文后续内容)</li>
</ol>
<p>另一个方面，也许绝大多数人都听说过所谓的<code>热部署</code>。但是究竟怎么才能做到 <code>热部署</code>(话题开得有点大哈。Y_Y 本文不讲这个)</p>
<p>操作字节码一定是一个逃不开的话题，毕竟 Class 就是所谓的被加载到内存的字节码嘛。</p>
<p>如何操作字节码? ASM, CGlib, Java Proxy, Javassist ? 不过这些都要等到需要被操作的类被加载了才行啊，似乎有点晚&hellip;</p>
<p>Java 提供了一个可行的机制，用来在 ClassLoader 加载字节码之前完成对操作字节码的目的</p>
<h2 id="instrumentation">Instrumentation</h2>
<p><code>java.lang.instrument.Instrumentation</code> 类为提供直接操作 Java 字节码的又一个途径(虽然 Java Doc 的说明是用来检测 Java 代码的)</p>
<p>相信我这个说明是没有问题的。毕竟完成对代码检测的途径是直接修改字节码。</p>
<p>下列有两种方法可以达到目的</p>
<ol>
<li>当 JVM 以指示一个代理类的方式启动时，将传递给代理类的 premain 方法一个 Instrumentation 实例。</li>
<li>当 JVM 提供某种机制在 JVM 启动之后某一时刻启动代理时，将传递给代理代码的 agentmain 方法一个 Instrumentation 实例。</li>
</ol>
<p>话不多说，下面将全部以实例来展现对这种 JVM 检测机制(虽然例子已经脱离了<em>检测</em>的目的)的使用</p>
<h2 id="对各方法进行执行时间统计">对各方法进行执行时间统计</h2>
<h3 id="随-jvm-一起启动">随 JVM 一起启动</h3>
<p>基本实例: 将对特定包 <code>me.fangfeng.client</code> 下的每个方法执行计时</p>
<p>首先了解一下 client 包的内容:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">package</span> <span style="color:#0e84b5;font-weight:bold">me.fangfeng.client</span><span style="color:#666">;</span>

<span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic"> * Main.java
</span><span style="color:#60a0b0;font-style:italic"> * 执行两个方法，rand() &amp; sleep() 
</span><span style="color:#60a0b0;font-style:italic"> *
</span><span style="color:#60a0b0;font-style:italic"> * @author fangfeng
</span><span style="color:#60a0b0;font-style:italic"> * @since 2018/8/7
</span><span style="color:#60a0b0;font-style:italic"> */</span>
<span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Main</span> <span style="color:#666">{</span>

    <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">sleep</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
            Thread<span style="color:#666">.</span><span style="color:#4070a0">sleep</span><span style="color:#666">(</span>5000<span style="color:#666">);</span>
        <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>InterruptedException e<span style="color:#666">)</span> <span style="color:#666">{</span>
            e<span style="color:#666">.</span><span style="color:#4070a0">printStackTrace</span><span style="color:#666">();</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#666">{</span>

        Rand rand <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Rand<span style="color:#666">();</span>

        <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#902000">int</span> i<span style="color:#666">=</span>0<span style="color:#666">;</span>i<span style="color:#666">&lt;</span>10<span style="color:#666">;</span>i<span style="color:#666">++)</span> <span style="color:#666">{</span>
            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;&gt;&gt;&gt; start Rand.run() &lt;&lt;&lt;&#34;</span><span style="color:#666">);</span>
            rand<span style="color:#666">.</span><span style="color:#4070a0">run</span><span style="color:#666">();</span>
            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;&gt;&gt;&gt; end Rand.run() &lt;&lt;&lt;&#34;</span><span style="color:#666">);</span>

            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">();</span>

            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;&gt;&gt;&gt; start Main.sleep() &lt;&lt;&lt;&#34;</span><span style="color:#666">);</span>
            Main<span style="color:#666">.</span><span style="color:#4070a0">sleep</span><span style="color:#666">();</span>
            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;&gt;&gt;&gt; end MAin.sleep() &lt;&lt;&lt;&#34;</span><span style="color:#666">);</span>

            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">();</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">package</span> <span style="color:#0e84b5;font-weight:bold">me.fangfeng.client</span><span style="color:#666">;</span>

<span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic"> * Rand.java
</span><span style="color:#60a0b0;font-style:italic"> * @author fangfeng
</span><span style="color:#60a0b0;font-style:italic"> * @since 2018/8/7
</span><span style="color:#60a0b0;font-style:italic"> */</span>
<span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Rand</span> <span style="color:#666">{</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:bold">while</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">true</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#902000">double</span> rand <span style="color:#666">=</span> Math<span style="color:#666">.</span><span style="color:#4070a0">random</span><span style="color:#666">();</span>
            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>rand <span style="color:#666">&gt;</span> 0<span style="color:#666">.</span><span style="color:#4070a0">995</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span>String<span style="color:#666">.</span><span style="color:#4070a0">format</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;get random, values %f&#34;</span><span style="color:#666">,</span> rand<span style="color:#666">));</span>
                <span style="color:#007020;font-weight:bold">return</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>接着，来构造一个代理类，以及最重要的 <code>premain</code> 方法</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">package</span> <span style="color:#0e84b5;font-weight:bold">me.fangfeng.javaagent</span><span style="color:#666">;</span>

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">java.lang.instrument.Instrumentation</span><span style="color:#666">;</span>

<span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic"> * Agent - 代理
</span><span style="color:#60a0b0;font-style:italic"> * 基于 JVM TI (JVM Tool Interface) 实现的 Java ClassFile 的增强
</span><span style="color:#60a0b0;font-style:italic"> * @author fangfeng
</span><span style="color:#60a0b0;font-style:italic"> * @since 2018/8/7
</span><span style="color:#60a0b0;font-style:italic"> */</span>
<span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Agent</span> <span style="color:#666">{</span>

    <span style="color:#60a0b0;font-style:italic">// premain 将 JVM 初始化后，main(String... ) 执行前调用
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">premain</span><span style="color:#666">(</span>String args<span style="color:#666">,</span> Instrumentation instrumentation<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#60a0b0;font-style:italic">// new 一个转换器实例
</span><span style="color:#60a0b0;font-style:italic"></span>        ClassTimer transformer <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ClassTimer<span style="color:#666">();</span>
        instrumentation<span style="color:#666">.</span><span style="color:#4070a0">addTransformer</span><span style="color:#666">(</span>transformer<span style="color:#666">);</span>
    <span style="color:#666">}</span>

    <span style="color:#60a0b0;font-style:italic">// 之后的 agentmain(...) 将在这里提供，暂时隐去，避免对对读者产生干扰
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">package</span> <span style="color:#0e84b5;font-weight:bold">me.fangfeng.javaagent</span><span style="color:#666">;</span>

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">org.objectweb.asm.ClassReader</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">org.objectweb.asm.ClassWriter</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">org.objectweb.asm.Opcodes</span><span style="color:#666">;</span>

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">java.lang.instrument.ClassFileTransformer</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">java.security.ProtectionDomain</span><span style="color:#666">;</span>

<span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic"> * @author fangfeng
</span><span style="color:#60a0b0;font-style:italic"> * @since 2018/8/7
</span><span style="color:#60a0b0;font-style:italic"> */</span>
<span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ClassTimer</span> <span style="color:#007020;font-weight:bold">implements</span> ClassFileTransformer <span style="color:#666">{</span>

    <span style="color:#555;font-weight:bold">@Override</span>
    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">byte</span><span style="color:#666">[]</span> <span style="color:#06287e">transform</span><span style="color:#666">(</span>ClassLoader loader<span style="color:#666">,</span> String className<span style="color:#666">,</span> Class<span style="color:#666">&lt;?&gt;</span> classBeingRedefined<span style="color:#666">,</span> ProtectionDomain protectionDomain<span style="color:#666">,</span> <span style="color:#902000">byte</span><span style="color:#666">[]</span> classfileBuffer<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#60a0b0;font-style:italic">// 这里涉及到了 ASM 的内容，主要目的是向每个方法块的开始及方法块的结束部分插入与计时器有关的代码
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#60a0b0;font-style:italic">// 如果想了解 ASM 的内容，请参阅 https://dormouse-none.github.io/2018-06-25-ASM-Core/  提供了一些基础性的内容，更多的请自行学习
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#60a0b0;font-style:italic">// 不了解具体内容将不影响对主体内容的理解
</span><span style="color:#60a0b0;font-style:italic"></span>        ClassReader cr <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ClassReader<span style="color:#666">(</span>classfileBuffer<span style="color:#666">);</span>
        ClassWriter cw <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ClassWriter<span style="color:#666">(</span>ClassWriter<span style="color:#666">.</span><span style="color:#4070a0">COMPUTE_FRAMES</span><span style="color:#666">);</span>
        MyClassWriter mcw <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> MyClassWriter<span style="color:#666">(</span>Opcodes<span style="color:#666">.</span><span style="color:#4070a0">ASM6</span><span style="color:#666">,</span> cw<span style="color:#666">);</span>
        cr<span style="color:#666">.</span><span style="color:#4070a0">accept</span><span style="color:#666">(</span>mcw<span style="color:#666">,</span> ClassReader<span style="color:#666">.</span><span style="color:#4070a0">EXPAND_FRAMES</span><span style="color:#666">);</span>
        <span style="color:#007020;font-weight:bold">return</span> cw<span style="color:#666">.</span><span style="color:#4070a0">toByteArray</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>其它代码略，详见附件。</p>
<p>Java 这种对操作字节码的支持有个坑爹的地方，就是不得不打包成 Jar 来使用。</p>
<p>具体来看一下</p>
<p><code>me.fangfeng.javaagent</code> 包中包括</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fublsbbdw0j309o07g74u.jpg" alt=""></p>
<p>将被打包成 <code>agent.jar</code> 来使用</p>
<p>首先，来看一下需要打包在 <code>agent.jar</code> 的 <strong>MANIFEST.MF</strong> 的内容</p>
<pre><code>Manifest-Version: 1.0
Class-Path: /Users/fangfeng/.m2/repository/org/ow2/asm/asm/6.1.1/asm-6.1.1.jar
Premain-Class: me.fangfeng.javaagent.Agent
Can-Retransform-Classes: true
</code></pre><p>再来个 SHELL 脚本，用来给打包这个 Jar</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#007020">#!/bin/bash
</span><span style="color:#007020"></span>
<span style="color:#60a0b0;font-style:italic"># 编译 me.fangfeng.javaagent 包下的类</span>
javac -cp .:/Users/fangfeng/.m2/repository/org/ow2/asm/asm/6.1.1/asm-6.1.1.jar me/fangfeng/javaagent/Agent.java me/fangfeng/javaagent/ClassTimer.java me/fangfeng/javaagent/MyClassWriter.java me/fangfeng/javaagent/MyMethodWriter.java me/fangfeng/javaagent/StaticTimer.java

<span style="color:#60a0b0;font-style:italic"># 打包 me.fangfeng.javaagent 的 .class -&gt; agent.jar</span>
jar cvfm agent.jar MANIFEST-agent.MF me/fangfeng/javaagent/Agent.class me/fangfeng/javaagent/ClassTimer.class me/fangfeng/javaagent/MyClassWriter.class me/fangfeng/javaagent/MyMethodWriter.class me/fangfeng/javaagent/StaticTimer.class

<span style="color:#60a0b0;font-style:italic"># 编译 me.fangfeng.client 包下的类</span>
javac me/fangfeng/client/Main.java me/fangfeng/client/Rand.java

<span style="color:#60a0b0;font-style:italic"># 以 me.fangfeng.client.Main 作为主类启动</span>
java -javaagent:agent.jar me.fangfeng.client.Main
</code></pre></div><p>执行后，可以看到类似如下内容:</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fubmp354ejj30tq0rmtdp.jpg" alt=""></p>
<p>而直接用 <code>java me.fangfeng.client.Main</code> 的执行结果是:</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fubmqmj4uhj30j00f0dho.jpg" alt=""></p>
<p>从理论上来讲，<code>-javaagent:agent.jar</code> 配合 <code>agent.jar</code> 中的 MANIFEST.MF 文件，
使得 JVM 在初始化之后触发了被声明为 <code>Pre-Main</code> 的 me.fangfeng.javaagent.Agent 类的 premain(&hellip;) 方法。</p>
<p>并为 ClassLoader 在加载类的流程上增加了一层<strong>拦截器</strong> (这里是 ClassTimer.java 类，它实现了 <code>ClassFileTransformer</code> 接口</p>
<p>另外，<code>Can-Retransform-Classes: true</code> 的配置使得 ClassTimer 被允许对字节码进行重新转换。(而操作字节码是通过 ASM 来实现的)</p>
<h3 id="在运行中进行增强">在运行中进行增强</h3>
<p>随着程序启动时直接使用了 <code>-javaagent</code> 选项。</p>
<p>那么是否存在在程序运行中进行额外代理操作的支持呢？当然是可以的。这里要借助 Java 提供的另一个类 com.sun.tools.attach.VirtualMachine 。</p>
<p>启动一个新的进程来连接到 正在运行中的进程，并令其加载 java agent。</p>
<p>基本的类与上一节的描述相同，主要是包 <code>me.fangfeng.javaagent.*</code> 和 <code>me.fangfeng.client.*</code></p>
<p>新增一个类 <code>me.fangfeng.javaagent.Main</code> 用来启动另一个进程，并要求运行中的 java 进程加载 agent.jar 来进行增强。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">package</span> <span style="color:#0e84b5;font-weight:bold">me.fangfeng.javaagent</span><span style="color:#666">;</span>

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">com.sun.tools.attach.AgentInitializationException</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">com.sun.tools.attach.AgentLoadException</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">com.sun.tools.attach.AttachNotSupportedException</span><span style="color:#666">;</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">com.sun.tools.attach.VirtualMachine</span><span style="color:#666">;</span>

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">java.io.IOException</span><span style="color:#666">;</span>

<span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic"> * @author fangfeng
</span><span style="color:#60a0b0;font-style:italic"> * @since 2018/8/7
</span><span style="color:#60a0b0;font-style:italic"> */</span>
<span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Main</span> <span style="color:#666">{</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> IOException<span style="color:#666">,</span> AttachNotSupportedException<span style="color:#666">,</span> AgentLoadException<span style="color:#666">,</span> AgentInitializationException <span style="color:#666">{</span>
        VirtualMachine vm <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">;</span>
        <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
            <span style="color:#60a0b0;font-style:italic">// 通过 VirtualMachine 连接到 运行中的进程 (可以通过 jps 找到进程号)
</span><span style="color:#60a0b0;font-style:italic"></span>            vm <span style="color:#666">=</span> VirtualMachine<span style="color:#666">.</span><span style="color:#4070a0">attach</span><span style="color:#666">(&lt;</span>PID<span style="color:#666">&gt;);</span>
            vm<span style="color:#666">.</span><span style="color:#4070a0">loadAgent</span><span style="color:#666">(&lt;</span>agent<span style="color:#666">.</span><span style="color:#4070a0">jar</span> 的路径<span style="color:#666">&gt;);</span>
        <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">finally</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>vm <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                vm<span style="color:#666">.</span><span style="color:#4070a0">detach</span><span style="color:#666">();</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Agent</span> <span style="color:#666">{</span>

    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">premain</span><span style="color:#666">(</span>String args<span style="color:#666">,</span> Instrumentation instrumentation<span style="color:#666">)</span> <span style="color:#666">{</span>
        ClassTimer transformer <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ClassTimer<span style="color:#666">();</span>
        instrumentation<span style="color:#666">.</span><span style="color:#4070a0">addTransformer</span><span style="color:#666">(</span>transformer<span style="color:#666">);</span>
    <span style="color:#666">}</span>

    <span style="color:#60a0b0;font-style:italic">// 现在在 Agent.java 上补上 agentmain(...) 的具体实现
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">agentmain</span><span style="color:#666">(</span>String args<span style="color:#666">,</span> Instrumentation instrumentation<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> UnmodifiableClassException <span style="color:#666">{</span>
        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;SUCCESS AGENTMAIN&#34;</span><span style="color:#666">);</span>
        ClassTimer transformer <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> ClassTimer<span style="color:#666">();</span>
        <span style="color:#60a0b0;font-style:italic">// add Transformer
</span><span style="color:#60a0b0;font-style:italic"></span>        instrumentation<span style="color:#666">.</span><span style="color:#4070a0">addTransformer</span><span style="color:#666">(</span>transformer<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">true</span><span style="color:#666">);</span>
        <span style="color:#60a0b0;font-style:italic">// 对 Rand.class 进行重新转换
</span><span style="color:#60a0b0;font-style:italic"></span>        instrumentation<span style="color:#666">.</span><span style="color:#4070a0">retransformClasses</span><span style="color:#666">(</span>Rand<span style="color:#666">.</span><span style="color:#4070a0">class</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>其它内容基本相同</p>
<p>首先需要先打包 agent.jar 。当然，如果是顺着本文的顺序进行本机实验，则 agent.jar 已经存在</p>
<p>先启动进程 <code>java me.fangfeng.client.Main</code></p>
<p>通过 <code>jps</code> 获取 Main 进程的 <strong>PID</strong></p>
<p>在 <code>java me.fangfeng.javaagent.Main</code> 中替换上进程号，并执行</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fuboclcelsj30tu152dlw.jpg" alt=""></p>
<p>从执行结果可以看到，原进程首先正常执行代码，等到被 load Agent 之后，字节码已经有了新的变化，从而导致输出结果动态的产生了变化。</p>
<p><em>当然，需要注意的是，执行中的进程被要求 load Agent 之后，运行中的 Class 将被改写，并始终如此，知道进程终止。再下一次重新启动</em></p>
<h2 id="btrace">BTrace</h2>
<p>以上描述的内容也可以理解为是 BTrace 实现的基础。毕竟，JVMTI (JVM Tool Interface) 原本的目的就是赋予使用者一个在运行中
查询系统各项数据的权利</p>
<p>当然，实现上，上述代码直接将各种增强(计时)硬编码到该进程中，同时统一使用了该进程的输入输出。</p>
<p>但是，BTrace 通过 Socket 将这些分离，检测代码通过 Socket 发回新的进程来维持输入输出。</p>
<p>在此，不再细说。</p>
<h2 id="附录">附录</h2>
<p>[1]. 示例代码: <a href="https://github.com/DorMOUSE-None/Repo/raw/master/instru.zip">instru.zip</a>
[2]. <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/Instrumentation.html">java.lang.instrument.Instrumentation</a>
[3]. <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html">Package java.lang.instrument</a></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-category">
              <a href="/categories/%e6%8a%80%e6%9c%af/">
                技术
              </a>
            </div>
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

<div class="releated-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2018-06-25-asm-%E6%A0%B8%E5%BF%83%E5%8C%85%E5%9F%BA%E6%9C%AC%E5%86%85%E5%AE%B9%E6%BC%AB%E8%B0%88/">ASM 核心包基本内容漫谈</a></li>
    
    <li><a href="/posts/2018-07-10-cglib-enhancer-%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">CGlib Enhancer 主流程源码解析</a></li>
    
    <li><a href="/posts/2018-07-04-java-%E5%AE%89%E5%85%A8%E8%AE%BF%E9%97%AE%E4%B8%8E%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/">Java 安全访问与权限控制</a></li>
    
  </ul>
</div>

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/posts/" target="_blank">Posts</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

 
  </body>
</html>
