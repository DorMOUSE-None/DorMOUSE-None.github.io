<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2018-07-10-cglib-enhancer-%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2018-07-10-cglib-enhancer-%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/www.ffutop.com\/"
      },
      "articleSection" : "posts",
      "name" : "CGlib Enhancer 主流程源码解析",
      "headline" : "CGlib Enhancer 主流程源码解析",
      "description" : "\x3ch2 id=\x22前言\x22\x3e前言\x3c\/h2\x3e\n\x3cp\x3e此博文写作的目的:\x3c\/p\x3e\n\x3cul\x3e\n\x3cli\x3e(Core) 通过了解 CGlib Enhancer 的整个调用链，了解其对于唯一依赖的 ASM 库的调用方式。\x3c\/li\x3e\n\x3cli\x3e基于 Enhancer 对已有字节码进行增强的进一步理解与掌握。\x3c\/li\x3e\n\x3c\/ul\x3e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2018",
      "datePublished": "2018-07-10 00:00:00 \x2b0000 UTC",
      "dateModified" : "2018-07-10 00:00:00 \x2b0000 UTC",
      "url" : "https:\/\/www.ffutop.com\/posts\/2018-07-10-cglib-enhancer-%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90\/",
      "keywords" : [ "CGlib","ASM", ]
  }
</script>
<title>CGlib Enhancer 主流程源码解析 - Utop&#39;s Blog</title>
  <meta property="og:title" content="CGlib Enhancer 主流程源码解析 - Utop&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="前言
此博文写作的目的:

(Core) 通过了解 CGlib Enhancer 的整个调用链，了解其对于唯一依赖的 ASM 库的调用方式。
基于 Enhancer 对已有字节码进行增强的进一步理解与掌握。
" />
  <meta name="description" content="前言
此博文写作的目的:

(Core) 通过了解 CGlib Enhancer 的整个调用链，了解其对于唯一依赖的 ASM 库的调用方式。
基于 Enhancer 对已有字节码进行增强的进一步理解与掌握。
" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/github-markdown.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-92258941-1"></script>
</head>


<body>
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">CGlib Enhancer 主流程源码解析</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2018-07-10 00:00:00 UTC">
                10 Jul 2018
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="前言">前言</h2>
<p>此博文写作的目的:</p>
<ul>
<li>(Core) 通过了解 CGlib Enhancer 的整个调用链，了解其对于唯一依赖的 ASM 库的调用方式。</li>
<li>基于 Enhancer 对已有字节码进行增强的进一步理解与掌握。</li>
</ul>
<h2 id="enhancer">Enhancer</h2>
<p>从这篇不是官方但更胜于官方文档的 <a href="https://mydailyjava.blogspot.com/2013/11/cglib-missing-manual.html">CGlib Guide</a> 来看，它首先提到的第一个类就是 Enhancer。
其被用于创建 Java 代理类，相较于 Java 标准库的 Proxy 类，它<strong>特别地</strong>，能够支持那些没有实现接口的类的代理工作。</p>
<h3 id="enhancer-简单示例展示">Enhancer 简单示例展示</h3>
<p>针对现有的 SampleClass 类</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SampleClass</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">test</span><span style="color:#f92672">(</span>String input<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World!&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>使用 CGlib 的 Enhancer 对 SampleClass 进行增强，下列操作的目的在于将 test(String) 方法的返回值改写成 &ldquo;Hello cglib!&rdquo;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Test</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testFixedValue</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// new 一个 Enhancer 实例
</span><span style="color:#75715e"></span>    Enhancer enhancer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Enhancer<span style="color:#f92672">();</span>
    <span style="color:#75715e">// 声明使用的父类是 SampleClass
</span><span style="color:#75715e"></span>    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setSuperclass</span><span style="color:#f92672">(</span>SampleClass<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// 设置回调方法 - 回调方法实现为 FixedValue (固定值) .
</span><span style="color:#75715e"></span>    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> FixedValue<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">loadObject</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello cglib!&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    <span style="color:#75715e">// 创建 SampleClass 的代理子类实例
</span><span style="color:#75715e"></span>    SampleClass proxy <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SampleClass<span style="color:#f92672">)</span> enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">();</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertEquals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello cglib!&#34;</span><span style="color:#f92672">,</span> proxy<span style="color:#f92672">.</span><span style="color:#a6e22e">test</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>简单测试上述代码，可以了解到确实，代理类的 test(String) 方法的返回值被改写了。
那么，究竟这种操作是如何实现的？下面👇将进行具体的探究。</p>
<h2 id="调用链跟踪">调用链跟踪</h2>
<h3 id="高度抽象的时序图">高度抽象的时序图</h3>
<p><img src="https://img.ffutop.com/11657CC2-D2A9-4ADD-89B8-6359C39C6181.jpg" alt="Enhancer 调用链 时序图"></p>
<p><em>下列内容将根据时序图进行组织，根据调用编号(1,2,3&hellip;)进行展开</em></p>
<h3 id="seq-1">Seq 1.</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">create</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    classOnly <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    argumentTypes <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> createHelper<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">[]</span> argumentTypes<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> arguments<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    classOnly <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>argumentTypes <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> arguments <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> argumentTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> arguments<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Arguments must be non-null and of equal length&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">argumentTypes</span> <span style="color:#f92672">=</span> argumentTypes<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">arguments</span> <span style="color:#f92672">=</span> arguments<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> createHelper<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上述两个 <code>create(...)</code> 方法。结合上一节的使用示例，可以看到 <code>create()</code> 对应的<strong>无参构造</strong>。
存在无参构造，那么<strong>有参的构造方法</strong>显然也是应该被支持id。<code>create(Class[], Object[])</code> 正是为了这个目标而存在。通过提供参数类型数组和参数实例数组，可以唯一地定位及调用代理类的特定构造方法。</p>
<p>这个方法比较简单，只是将 Enhancer 作为一个数据内容的持有者，重置了新代理类将使用的构造函数参数内容，之后就直接调用了 <code>createHelper()</code> 。</p>
<h3 id="seq-2">Seq 2.</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> Object <span style="color:#a6e22e">createHelper</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 对预声明的回调方法进行验证，要求 [多个回调就必须存在 CallbackFilter 作为调度器]
</span><span style="color:#75715e"></span>    preValidate<span style="color:#f92672">();</span>
    <span style="color:#75715e">// 构建一个对这类增强操作唯一定位的 key
</span><span style="color:#75715e"></span>    Object key <span style="color:#f92672">=</span> KEY_FACTORY<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">((</span>superclass <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> superclass<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
            ReflectUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getNames</span><span style="color:#f92672">(</span>interfaces<span style="color:#f92672">),</span>
            filter <span style="color:#f92672">==</span> ALL_ZERO <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> WeakCacheKey<span style="color:#f92672">&lt;</span>CallbackFilter<span style="color:#f92672">&gt;(</span>filter<span style="color:#f92672">),</span>
            callbackTypes<span style="color:#f92672">,</span>
            useFactory<span style="color:#f92672">,</span>
            interceptDuringConstruction<span style="color:#f92672">,</span>
            serialVersionUID<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">currentKey</span> <span style="color:#f92672">=</span> key<span style="color:#f92672">;</span>
    <span style="color:#75715e">// 调用父类通过的 create(...) 方法
</span><span style="color:#75715e"></span>    Object result <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="seq-3">Seq 3.</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>Object key<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 获取用于 加载 生成类 的 ClassLoader
</span><span style="color:#75715e"></span>        ClassLoader loader <span style="color:#f92672">=</span> getClassLoader<span style="color:#f92672">();</span>
        <span style="color:#75715e">// 从缓存中加载 这个 ClassLoader 过去加载的相关数据
</span><span style="color:#75715e"></span>        Map<span style="color:#f92672">&lt;</span>ClassLoader<span style="color:#f92672">,</span> ClassLoaderData<span style="color:#f92672">&gt;</span> cache <span style="color:#f92672">=</span> CACHE<span style="color:#f92672">;</span>
        ClassLoaderData data <span style="color:#f92672">=</span> cache<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>loader<span style="color:#f92672">);</span>
        <span style="color:#75715e">// 如果在 缓存 中找不到，则初始化构造关于这个 ClassLoader 的数据实例
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>data <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 同步
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>AbstractClassGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// 进入同步块后的 再次确认，避免重复初始化构建
</span><span style="color:#75715e"></span>                cache <span style="color:#f92672">=</span> CACHE<span style="color:#f92672">;</span>
                data <span style="color:#f92672">=</span> cache<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>loader<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>data <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// 构建新的 缓存，拷贝原有的缓存集的内容
</span><span style="color:#75715e"></span>                    Map<span style="color:#f92672">&lt;</span>ClassLoader<span style="color:#f92672">,</span> ClassLoaderData<span style="color:#f92672">&gt;</span> newCache <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WeakHashMap<span style="color:#f92672">&lt;</span>ClassLoader<span style="color:#f92672">,</span> ClassLoaderData<span style="color:#f92672">&gt;(</span>cache<span style="color:#f92672">);</span>
                    <span style="color:#75715e">// 初始化 ClassLoaderData ，真正的构造操作
</span><span style="color:#75715e"></span>                    data <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassLoaderData<span style="color:#f92672">(</span>loader<span style="color:#f92672">);</span>
                    <span style="color:#75715e">// 添加到缓存中
</span><span style="color:#75715e"></span>                    newCache<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>loader<span style="color:#f92672">,</span> data<span style="color:#f92672">);</span>
                    CACHE <span style="color:#f92672">=</span> newCache<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> key<span style="color:#f92672">;</span>
        Object obj <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> getUseCache<span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>obj <span style="color:#66d9ef">instanceof</span> Class<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 初次实例化操作，就是 Class 利用反射来进行实例化
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> firstInstance<span style="color:#f92672">((</span>Class<span style="color:#f92672">)</span> obj<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 非初次实例化，则是从 ClassLoaderData 中得到的之前维护的内容
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> nextInstance<span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Error e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> CodeGenerationException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这部分内容比较多，且是调用链比较重要的一环。<strong>Seq 4.</strong> 和 <strong>Seq 5.</strong> 将作为其子内容进行调用，但为了本博文的结构完整， <em>Seq 4. &amp; Seq5.</em> 的标题与 <em>Seq 3.</em> 标题同级</p>
<h3 id="seq-4">Seq 4.</h3>
<p>首先应该认识到，每个被加载的 Class ，在 <code>equal</code> 的判断过程中，依据的是同一个 ClassLoader 加载的同一 Class 才被认为是相同的，否则即使 Class 是同一个，但仍会被认为是不同的(由不同的 ClassLoader 加载)。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> ClassLoader <span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    ClassLoader t <span style="color:#f92672">=</span> classLoader<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        t <span style="color:#f92672">=</span> getDefaultClassLoader<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        t <span style="color:#f92672">=</span> getClass<span style="color:#f92672">().</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        t <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextClassLoader</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Cannot determine classloader&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>因此，在这部分中，首先需要确定的是由哪个 ClassLoader 进行加载的工作。<code>getClassLoader()</code> 的确定顺序是:</p>
<ol>
<li>具体实现类声明的 <strong>默认 ClassLoader</strong> 为第一优先级</li>
<li>加载当前类(这里是 Enhancer) 的 ClassLoader 为第二优先级</li>
<li><strong>当前线程上下文 ClassLoader</strong> 为第三优先级</li>
<li>抛出异常</li>
</ol>
<p>回到 <strong>Seq 3.</strong> 的内容，
下一步是对当前这个<strong>AbstractClassGenerator</strong> 维护的 CACHE 进行处理，如果在 CACHE 中能够得到以确定的 ClassLoader 为 Key 的键值对，则直接获取 ClassLoader 对应的值，否则将进行初始化构建一个新的 ClassLoaderData 作为这个 ClassLoader 的值。</p>
<h3 id="seq-5">Seq 5.</h3>
<p>在构建 ClassLoaderData 的过程中，最重要的一步:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ClassLoaderData</span><span style="color:#f92672">(</span>ClassLoader classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ClassLoader 不可为空
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>classLoader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;classLoader == null is not yet supported&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// 构建 ClassLoader 的弱引用
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">classLoader</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WeakReference<span style="color:#f92672">&lt;</span>ClassLoader<span style="color:#f92672">&gt;(</span>classLoader<span style="color:#f92672">);</span>
    <span style="color:#75715e">// 写了个后置调用的函数，用于懒加载，只有调用了 load.apply(...) 才会构建 生成类
</span><span style="color:#75715e"></span>    Function<span style="color:#f92672">&lt;</span>AbstractClassGenerator<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> load <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> Function<span style="color:#f92672">&lt;</span>AbstractClassGenerator<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>AbstractClassGenerator gen<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    Class klass <span style="color:#f92672">=</span> gen<span style="color:#f92672">.</span><span style="color:#a6e22e">generate</span><span style="color:#f92672">(</span>ClassLoaderData<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> gen<span style="color:#f92672">.</span><span style="color:#a6e22e">wrapCachedClass</span><span style="color:#f92672">(</span>klass<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">};</span>
    generatedClasses <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LoadingCache<span style="color:#f92672">&lt;</span>AbstractClassGenerator<span style="color:#f92672">,</span> Object<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;(</span>GET_KEY<span style="color:#f92672">,</span> load<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>构建了一个 Function 实例，这个 Function 作为函数式接口，预定义执行的具体流程，但由上下文确定具体的调用时刻。</p>
<h3 id="seq-6">Seq 6.</h3>
<p>在正确得到了 ClassLoader 对应的 ClassLoaderData 之后，ClassLoaderData 的 <code>get(...)</code> 方法将在特定的 ClassLoader 之下，进行更具体的加载新生成类的工作。
当然，这里的前提是新的生成类的字节码已经被构建:)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>AbstractClassGenerator gen<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> useCache<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 标记为不使用缓存，直接构建 新的生成类
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>useCache<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> gen<span style="color:#f92672">.</span><span style="color:#a6e22e">generate</span><span style="color:#f92672">(</span>ClassLoaderData<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// 使用缓冲的情况
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      Object cachedValue <span style="color:#f92672">=</span> generatedClasses<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>gen<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">return</span> gen<span style="color:#f92672">.</span><span style="color:#a6e22e">unwrapCachedValue</span><span style="color:#f92672">(</span>cachedValue<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看到 <code>gen.generate(ClassLoaderData.this)</code> 这段代码在 <code>get(...)</code> 方法和上一小节 <code>ClassLoaderData(...)</code> 构造方法的 Function 函数式实例都出现了。</p>
<p>实际上，这也是触发 ClassLoader 来加载动态生成的新 Class 的唯一入口。</p>
<p><em>判断逻辑</em> 的 <code>else</code> 内容的唯一区别就在于其构建的是一个加载缓存，将真正触发 gen.generate(ClassLoaderData.this) 的逻辑延迟。(不过，最终也还是会进行调用的，:) 这是毋庸置疑的)。</p>
<h3 id="seq-7">Seq 7.</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">protected</span> Class <span style="color:#a6e22e">generate</span><span style="color:#f92672">(</span>ClassLoaderData data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Class gen<span style="color:#f92672">;</span>
    Object save <span style="color:#f92672">=</span> CURRENT<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
    CURRENT<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 拿到用于加载生成类的 ClassLoader
</span><span style="color:#75715e"></span>        ClassLoader classLoader <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>classLoader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ClassLoader is null while trying to define class &#34;</span> <span style="color:#f92672">+</span>
                    getClassName<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;. It seems that the loader has been expired from a weak reference somehow. &#34;</span> <span style="color:#f92672">+</span>
                    <span style="color:#e6db74">&#34;Please file an issue at cglib&#39;s issue tracker.&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 构建一个合法的 生成类 的类名(非重复)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          String name <span style="color:#f92672">=</span> generateClassName<span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">getUniqueNamePredicate</span><span style="color:#f92672">());</span>
          data<span style="color:#f92672">.</span><span style="color:#a6e22e">reserveName</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
          <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setClassName</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>attemptLoad<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// 尝试直接通过 ClassLoader 进行加载
</span><span style="color:#75715e"></span>                gen <span style="color:#f92672">=</span> classLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>getClassName<span style="color:#f92672">());</span>
                <span style="color:#66d9ef">return</span> gen<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClassNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ignore
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 策略下的生成类构建方法
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> b <span style="color:#f92672">=</span> strategy<span style="color:#f92672">.</span><span style="color:#a6e22e">generate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// 通过解析字节码的形式获取 生成类的 className
</span><span style="color:#75715e"></span>        String className <span style="color:#f92672">=</span> ClassNameReader<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassName</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ClassReader<span style="color:#f92672">(</span>b<span style="color:#f92672">));</span>
        ProtectionDomain protectionDomain <span style="color:#f92672">=</span> getProtectionDomain<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>classLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// just in case
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 反射的形式加载 Class 类
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>protectionDomain <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                gen <span style="color:#f92672">=</span> ReflectUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">defineClass</span><span style="color:#f92672">(</span>className<span style="color:#f92672">,</span> b<span style="color:#f92672">,</span> classLoader<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                gen <span style="color:#f92672">=</span> ReflectUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">defineClass</span><span style="color:#f92672">(</span>className<span style="color:#f92672">,</span> b<span style="color:#f92672">,</span> classLoader<span style="color:#f92672">,</span> protectionDomain<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> gen<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RuntimeException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Error e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> CodeGenerationException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        CURRENT<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>save<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这个方法，就是操作字节码，加载 Class 的核心调度方法。</p>
<p>可以看到 <code>generateClassName(...)</code> 方法将构建一个当前 ClassLoader 下唯一, 不重复的新的类名。</p>
<p><code>strategy.generate(this)</code> 将通过特定策略实现的形式生成新的字节码</p>
<p><code>ReflectUtils.defineClass(className, b, classLoader)</code> 将使用反射使得 ClassLoader 来加载这个新的生成类。</p>
<h3 id="seq-8">Seq 8.</h3>
<p>生成新的不重复类名这部分不做过多陈述，可以简单进行了解，并熟悉 CGlib 默认的新类名的命名规则</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// DefaultNamePolicy
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getClassName</span><span style="color:#f92672">(</span>String prefix<span style="color:#f92672">,</span> String source<span style="color:#f92672">,</span> Object key<span style="color:#f92672">,</span> Predicate names<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prefix <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;net.sf.cglib.empty.Object&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prefix<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;java&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$&#34;</span> <span style="color:#f92672">+</span> prefix<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    String base <span style="color:#f92672">=</span>
        prefix <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;$$&#34;</span> <span style="color:#f92672">+</span>
        source<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>source<span style="color:#f92672">.</span><span style="color:#a6e22e">lastIndexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">+</span>
        getTag<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;$$&#34;</span> <span style="color:#f92672">+</span>
        Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">toHexString</span><span style="color:#f92672">(</span>STRESS_HASH_CODE <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
    String attempt <span style="color:#f92672">=</span> base<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>names<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>attempt<span style="color:#f92672">))</span>
        attempt <span style="color:#f92672">=</span> base <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> index<span style="color:#f92672">++;</span>
    <span style="color:#66d9ef">return</span> attempt<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="seq-9">Seq 9.</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 下列是 DefaultGeneratorStrategy 的实现
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">generate</span><span style="color:#f92672">(</span>ClassGenerator cg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    DebuggingClassWriter cw <span style="color:#f92672">=</span> getClassVisitor<span style="color:#f92672">();</span>
    transform<span style="color:#f92672">(</span>cg<span style="color:#f92672">).</span><span style="color:#a6e22e">generateClass</span><span style="color:#f92672">(</span>cw<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> transform<span style="color:#f92672">(</span>cw<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="seq-10">Seq 10.</h3>
<p>调用 <code>generateClass(ClassVisitor)</code> 将获得到新类的字节码。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">generateClass</span><span style="color:#f92672">(</span>ClassVisitor v<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 确定生成类的 父类
</span><span style="color:#75715e"></span>    Class sc <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>superclass <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">?</span> Object<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span> <span style="color:#f92672">:</span> superclass<span style="color:#f92672">;</span>

    <span style="color:#75715e">// 父类标识符不可以为 final
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>TypeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isFinal</span><span style="color:#f92672">(</span>sc<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()))</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Cannot subclass final class &#34;</span> <span style="color:#f92672">+</span> sc<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
    <span style="color:#75715e">// 获取父类直接声明的构造方法
</span><span style="color:#75715e"></span>    List constructors <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>sc<span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredConstructors</span><span style="color:#f92672">()));</span>
    filterConstructors<span style="color:#f92672">(</span>sc<span style="color:#f92672">,</span> constructors<span style="color:#f92672">);</span>

    <span style="color:#75715e">// Order is very important: must add superclass, then
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// its superclass chain, then each interface and
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// its superinterfaces.
</span><span style="color:#75715e"></span>    List actualMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">();</span>
    List interfaceMethods <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">final</span> Set forcePublic <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">();</span>
    <span style="color:#75715e">// 从父类中提取各种信息
</span><span style="color:#75715e"></span>    getMethods<span style="color:#f92672">(</span>sc<span style="color:#f92672">,</span> interfaces<span style="color:#f92672">,</span> actualMethods<span style="color:#f92672">,</span> interfaceMethods<span style="color:#f92672">,</span> forcePublic<span style="color:#f92672">);</span>

    List methods <span style="color:#f92672">=</span> CollectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>actualMethods<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Transformer<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>Object value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Method method <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Method<span style="color:#f92672">)</span>value<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">int</span> modifiers <span style="color:#f92672">=</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_FINAL</span>
                <span style="color:#f92672">|</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()</span>
                   <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_ABSTRACT</span>
                   <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_NATIVE</span>
                   <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_SYNCHRONIZED</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>forcePublic<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>MethodWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>method<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
                modifiers <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>modifiers <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PROTECTED</span><span style="color:#f92672">)</span> <span style="color:#f92672">|</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PUBLIC</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> ReflectUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodInfo</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> modifiers<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>

    ClassEmitter e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassEmitter<span style="color:#f92672">(</span>v<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentData <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    e<span style="color:#f92672">.</span><span style="color:#a6e22e">begin_class</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">V1_2</span><span style="color:#f92672">,</span>
                  Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PUBLIC</span><span style="color:#f92672">,</span>
                  getClassName<span style="color:#f92672">(),</span>
                  Type<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">(</span>sc<span style="color:#f92672">),</span>
                  <span style="color:#f92672">(</span>useFactory <span style="color:#f92672">?</span>
                   TypeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>TypeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypes</span><span style="color:#f92672">(</span>interfaces<span style="color:#f92672">),</span> FACTORY<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
                   TypeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypes</span><span style="color:#f92672">(</span>interfaces<span style="color:#f92672">)),</span>
                  Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">SOURCE_FILE</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        e<span style="color:#f92672">.</span><span style="color:#a6e22e">begin_class</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">V1_2</span><span style="color:#f92672">,</span>
                Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PUBLIC</span><span style="color:#f92672">,</span>
                getClassName<span style="color:#f92672">(),</span>
                <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                <span style="color:#66d9ef">new</span> Type<span style="color:#f92672">[]{</span>FACTORY<span style="color:#f92672">},</span>
                Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">SOURCE_FILE</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    List constructorInfo <span style="color:#f92672">=</span> CollectionUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>constructors<span style="color:#f92672">,</span> MethodInfoTransformer<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">());</span>

    e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PRIVATE</span><span style="color:#f92672">,</span> BOUND_FIELD<span style="color:#f92672">,</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">BOOLEAN_TYPE</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PUBLIC</span> <span style="color:#f92672">|</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_STATIC</span><span style="color:#f92672">,</span> FACTORY_DATA_FIELD<span style="color:#f92672">,</span> OBJECT_TYPE<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>interceptDuringConstruction<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PRIVATE</span><span style="color:#f92672">,</span> CONSTRUCTED_FIELD<span style="color:#f92672">,</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">BOOLEAN_TYPE</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FINAL_STATIC</span><span style="color:#f92672">,</span> THREAD_CALLBACKS_FIELD<span style="color:#f92672">,</span> THREAD_LOCAL<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FINAL_STATIC</span><span style="color:#f92672">,</span> STATIC_CALLBACKS_FIELD<span style="color:#f92672">,</span> CALLBACK_ARRAY<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>serialVersionUID <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FINAL_STATIC</span><span style="color:#f92672">,</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">SUID_FIELD_NAME</span><span style="color:#f92672">,</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">LONG_TYPE</span><span style="color:#f92672">,</span> serialVersionUID<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> callbackTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PRIVATE</span><span style="color:#f92672">,</span> getCallbackField<span style="color:#f92672">(</span>i<span style="color:#f92672">),</span> callbackTypes<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// This is declared private to avoid &#34;public field&#34; pollution
</span><span style="color:#75715e"></span>    e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PRIVATE</span> <span style="color:#f92672">|</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_STATIC</span><span style="color:#f92672">,</span> CALLBACK_FILTER_FIELD<span style="color:#f92672">,</span> OBJECT_TYPE<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentData <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        emitMethods<span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> methods<span style="color:#f92672">,</span> actualMethods<span style="color:#f92672">);</span>
        emitConstructors<span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> constructorInfo<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        emitDefaultConstructor<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    emitSetThreadCallbacks<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
    emitSetStaticCallbacks<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
    emitBindCallbacks<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>useFactory <span style="color:#f92672">||</span> currentData <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> keys <span style="color:#f92672">=</span> getCallbackKeys<span style="color:#f92672">();</span>
        emitNewInstanceCallbacks<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
        emitNewInstanceCallback<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
        emitNewInstanceMultiarg<span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> constructorInfo<span style="color:#f92672">);</span>
        emitGetCallback<span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> keys<span style="color:#f92672">);</span>
        emitSetCallback<span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> keys<span style="color:#f92672">);</span>
        emitGetCallbacks<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
        emitSetCallbacks<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    e<span style="color:#f92672">.</span><span style="color:#a6e22e">end_class</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>generateClass(...)</code> 执行的操作和 ASM 库的 ClassVisitor 访问 Class 文件结构的流程基本类似。</p>
<p>从上述截取到的部分代码，例如:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e<span style="color:#f92672">.</span><span style="color:#a6e22e">begin_class</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">V1_2</span><span style="color:#f92672">,</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ACC_PUBLIC</span><span style="color:#f92672">,</span> getClassName<span style="color:#f92672">(),</span> Type<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">(</span>sc<span style="color:#f92672">),</span> 
        <span style="color:#f92672">(</span>useFactory <span style="color:#f92672">?</span> TypeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>TypeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypes</span><span style="color:#f92672">(</span>interfaces<span style="color:#f92672">),</span> FACTORY<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> TypeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypes</span><span style="color:#f92672">(</span>interfaces<span style="color:#f92672">)),</span>
        Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">SOURCE_FILE</span><span style="color:#f92672">);</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e<span style="color:#f92672">.</span><span style="color:#a6e22e">declare_field</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">PRIVATE_FINAL_STATIC</span><span style="color:#f92672">,</span> THREAD_CALLBACKS_FIELD<span style="color:#f92672">,</span> THREAD_LOCAL<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</code></pre></div><p>都与 <code>classVisitor.visit(...)</code> 以及 <code>classVisitor.visitField(...)</code> 相当类似。而事实上，这些方法的具体实现也确实调用了 cv.visitXxx(&hellip;) 。
毕竟，作为 CGlib 唯一依赖的库，ASM 还是可以说是难以替代的(既然已经有了可用的轮子，又何必重复造呢?)</p>
<h2 id="构造的实例">构造的实例</h2>
<p>下面将展示通过 CGlib 生成的新的类(由于生成的是字节码，懒得再自行解析 ClassFile 的内容，所有直接用 <code>IDEA</code> 做了字节码的解析)</p>
<p><strong>首先展示的需要进行增强的 SampleClass 的具体内容</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SampleClass</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">test</span><span style="color:#f92672">(</span>String input<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World!&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><strong>用于增强的简单代码</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 省略部分代码
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Enhancer enhancer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Enhancer<span style="color:#f92672">();</span>
    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setSuperclass</span><span style="color:#f92672">(</span>SampleClass<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">setCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> FixedValue<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">loadObject</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello cglib!&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    SampleClass proxy <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SampleClass<span style="color:#f92672">)</span> enhancer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><strong>动态生成的新的类</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//
</span><span style="color:#75715e">// Source code recreated from a .class file by IntelliJ IDEA
</span><span style="color:#75715e">// (powered by Fernflower decompiler)
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 不用过多关注，只是 CGlib 保证生成类与原有的类一定属于同一包下，偷懒直接把 SampleClass 写在 CGlib 项目里了
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> net.sf.cglib.samples<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> net.sf.cglib.proxy.Callback<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> net.sf.cglib.proxy.Factory<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> net.sf.cglib.proxy.FixedValue<span style="color:#f92672">;</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 新的类名，通过 $$EnhancerByCGLIB 以及 $$7cd64b81(这个是哈希值) 对类名进行唯一区分 
</span><span style="color:#75715e"> * 如果还是重复了，在动态生成前会进行类名的检测，并通过增加序号 &#34;_&lt;index&gt;&#34; 的形式进行进一步区分
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * 可以看到新生成的类继承了 SampleClass 
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SampleClass$$EnhancerByCGLIB$$7cd64b81</span> <span style="color:#66d9ef">extends</span> SampleClass <span style="color:#66d9ef">implements</span> Factory <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> CGLIB$BOUND<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object CGLIB$FACTORY_DATA<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal CGLIB$THREAD_CALLBACKS<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Callback<span style="color:#f92672">[]</span> CGLIB$STATIC_CALLBACKS<span style="color:#f92672">;</span>

    <span style="color:#75715e">// 绑定一个在增强中声明的 Callback 实例
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> FixedValue CGLIB$CALLBACK_0<span style="color:#f92672">;</span>
    <span style="color:#75715e">// 绑定一个静态的回调调度实例
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Object CGLIB$CALLBACK_FILTER<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">CGLIB$STATICHOOK1</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        CGLIB$THREAD_CALLBACKS <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">      * 对 test(String) 的方法的增强
</span><span style="color:#75715e">      */</span> 
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> String <span style="color:#a6e22e">test</span><span style="color:#f92672">(</span>String var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 在方法块中拿到 Callback 实例
</span><span style="color:#75715e"></span>        FixedValue var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 为空则尝试获取
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// 触发回调实例的方法获得返回值
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span>var10000<span style="color:#f92672">.</span><span style="color:#a6e22e">loadObject</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">      * 由于此次增强只声明了一个 Callback
</span><span style="color:#75715e">      * 因此所有方法的增强都相同, 都是调用这个回调方法获取
</span><span style="color:#75715e">      */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>Object var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        FixedValue var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        Object var2 <span style="color:#f92672">=</span> var10000<span style="color:#f92672">.</span><span style="color:#a6e22e">loadObject</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">/**
</span><span style="color:#75715e">         * 但是，此处会尝试强制转型
</span><span style="color:#75715e">         * 同时在最终执行失败的时候直接抛出运行时异常
</span><span style="color:#75715e">         * 毕竟上面增强的时候返回固定值 &#34;Hello, cglib!&#34;
</span><span style="color:#75715e">         */</span>
        <span style="color:#66d9ef">return</span> var2 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">:</span> <span style="color:#f92672">(</span>Boolean<span style="color:#f92672">)</span>var2<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> String <span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        FixedValue var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span>var10000<span style="color:#f92672">.</span><span style="color:#a6e22e">loadObject</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        FixedValue var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        Object var1 <span style="color:#f92672">=</span> var10000<span style="color:#f92672">.</span><span style="color:#a6e22e">loadObject</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> var1 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> <span style="color:#f92672">((</span>Number<span style="color:#f92672">)</span>var1<span style="color:#f92672">).</span><span style="color:#a6e22e">intValue</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> Object <span style="color:#a6e22e">clone</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> CloneNotSupportedException <span style="color:#f92672">{</span>
        FixedValue var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
            var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> var10000<span style="color:#f92672">.</span><span style="color:#a6e22e">loadObject</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SampleClass$$EnhancerByCGLIB$$7cd64b81</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">CGLIB$SET_THREAD_CALLBACKS</span><span style="color:#f92672">(</span>Callback<span style="color:#f92672">[]</span> var0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        CGLIB$THREAD_CALLBACKS<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>var0<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">CGLIB$SET_STATIC_CALLBACKS</span><span style="color:#f92672">(</span>Callback<span style="color:#f92672">[]</span> var0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        CGLIB$STATIC_CALLBACKS <span style="color:#f92672">=</span> var0<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">CGLIB$BIND_CALLBACKS</span><span style="color:#f92672">(</span>Object var0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var1 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#f92672">)</span>var0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>var1<span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$BOUND</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            var1<span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$BOUND</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            Object var10000 <span style="color:#f92672">=</span> CGLIB$THREAD_CALLBACKS<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>var10000 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                var10000 <span style="color:#f92672">=</span> CGLIB$STATIC_CALLBACKS<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>CGLIB$STATIC_CALLBACKS <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            var1<span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FixedValue<span style="color:#f92672">)((</span>Callback<span style="color:#f92672">[])</span>var10000<span style="color:#f92672">)[</span>0<span style="color:#f92672">];</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>Callback<span style="color:#f92672">[]</span> var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#f92672">(</span>var1<span style="color:#f92672">);</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#f92672">();</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#f92672">((</span>Callback<span style="color:#f92672">[])</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> var10000<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>Callback var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Callback<span style="color:#f92672">[]{</span>var1<span style="color:#f92672">});</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#f92672">();</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#f92672">((</span>Callback<span style="color:#f92672">[])</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> var10000<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">[]</span> var1<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> var2<span style="color:#f92672">,</span> Callback<span style="color:#f92672">[]</span> var3<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        CGLIB$SET_THREAD_CALLBACKS<span style="color:#f92672">(</span>var3<span style="color:#f92672">);</span>
        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SampleClass$$EnhancerByCGLIB$$7cd64b81<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">switch</span><span style="color:#f92672">(</span>var1<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> 0<span style="color:#f92672">:</span>
            var10000<span style="color:#f92672">.&lt;</span>init<span style="color:#f92672">&gt;();</span>
            CGLIB$SET_THREAD_CALLBACKS<span style="color:#f92672">((</span>Callback<span style="color:#f92672">[])</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> var10000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Constructor not found&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> Callback <span style="color:#a6e22e">getCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        FixedValue var10000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">switch</span><span style="color:#f92672">(</span>var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> 0<span style="color:#f92672">:</span>
            var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            var10000 <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> var10000<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setCallback</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> var1<span style="color:#f92672">,</span> Callback var2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span><span style="color:#f92672">(</span>var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> 0<span style="color:#f92672">:</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FixedValue<span style="color:#f92672">)</span>var2<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> Callback<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getCallbacks</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        CGLIB$BIND_CALLBACKS<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Callback<span style="color:#f92672">[]{</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span><span style="color:#f92672">};</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setCallbacks</span><span style="color:#f92672">(</span>Callback<span style="color:#f92672">[]</span> var1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CGLIB$CALLBACK_0</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>FixedValue<span style="color:#f92672">)</span>var1<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
        CGLIB$STATICHOOK1<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>从上面的生成类可以看出来，CGlib 所进行的增强，是在不直接对原有的方法体内容进行改造的基础上(例如上面的 test(String) 方法，没有直接改写成 <code>return &quot;Hello, cglib!</code> 的形式)，对方法执行之前入参或者方法执行之后的返回值进行一定的处理。</p>
<p>主要使用的形式就是将回调实例与原有方法进行绑定，并通过调用回调方法来实现方法的增强。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

<div class="releated-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2018-06-25-asm-%E6%A0%B8%E5%BF%83%E5%8C%85%E5%9F%BA%E6%9C%AC%E5%86%85%E5%AE%B9%E6%BC%AB%E8%B0%88/">ASM 核心包基本内容漫谈</a></li>
    
  </ul>
</div>

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

</body>

</html>
