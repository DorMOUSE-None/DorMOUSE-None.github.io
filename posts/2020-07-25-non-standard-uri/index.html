<!DOCTYPE html>
<html lang="zh-cmn-Hans-CN" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    
    <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2020-07-25-non-standard-uri/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2020-07-25-non-standard-uri/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.ffutop.com/"
      },
      "articleSection" : "posts",
      "name" : "URI不规范编码解决方案",
      "headline" : "URI不规范编码解决方案",
      "description" : "\u003cp\u003e\u003ca href=\"https://tools.ietf.org/rfc/rfc7230.txt\"\u003eRFC 7230\u003c/a\u003e 与 \u003ca href=\"https://tools.ietf.org/rfc/rfc3986.txt\"\u003eRFC 3986\u003c/a\u003e 定义了 HTTP/1.1 标准并对 URI 的编解码问题作出了规范。但是，文本形式的规范和最终落地的标准之间总是存在着差距。标准中共 82 个字符无需编码。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/?#@!$\u0026amp;'()*+,;_-.~\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e对于需要编码的字符，百分号编码方案要求 ASCII 字符表示成两个 16 进制值并添加前缀 \u003ccode\u003e%\u003c/code\u003e；对于非 ASCII 字符, 需要转换为 UTF-8 字节序, 然后每个字节按照上述方式表示成两个 16 进制值并添加前缀 \u003ccode\u003e%\u003c/code\u003e。比如 \u003ccode\u003e|\u003c/code\u003e 将被表示为 \u003ccode\u003e%7C\u003c/code\u003e 或 \u003ccode\u003e%7c\u003c/code\u003e（大小写无关）；\u003ccode\u003e啊\u003c/code\u003e 将被表示为 \u003ccode\u003e%E5%95%8A\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e最近因为 Tomcat 版本升级，遭遇了非标到标准实现的过渡，新版本 Tomcat 严格执行 RFC 规范直接将非标准的 URI 请求强制拒绝。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-plain\" data-lang=\"plain\"\u003e2020-07-15 16:02:12,931  INFO 1 --- [http-nio-8080-exec-7] o.a.c.h.Http11Processor                  : Error parsing HTTP request header\n Note: further occurrences of HTTP request parsing errors will be logged at DEBUG level.\njava.lang.IllegalArgumentException: Invalid character found in the request target. The valid characters are defined in RFC 7230 and RFC 3986\n        at org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:468) ~[tomcat-embed-core-9.0.22.jar!/:9.0.22]\n        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:294) [tomcat-embed-core-9.0.22.jar!/:9.0.22]\n        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66) [tomcat-embed-core-9.0.22.jar!/:9.0.22]\n        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853) [tomcat-embed-core-9.0.22.jar!/:9.0.22]\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587) [tomcat-embed-core-9.0.22.jar!/:9.0.22]\n        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49) [tomcat-embed-core-9.0.22.jar!/:9.0.22]\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\n        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) [tomcat-embed-core-9.0.22.jar!/:9.0.22]\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2020",
      "datePublished": "2020-07-25T00:00:00Z",
      "dateModified" : "2020-07-25T00:00:00Z",
      "url" : "https://www.ffutop.com/posts/2020-07-25-non-standard-uri/",
      "keywords" : [ "URI","precent-encoding", ]
  }
</script>
<title>URI不规范编码解决方案</title>
  <meta property="og:title" content="URI不规范编码解决方案" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="RFC 7230 与 RFC 3986 定义了 HTTP/1.1 标准并对 URI 的编解码问题作出了规范。但是，文本形式的规范和最终落地的标准之间总是存在着差距。标准中共 82 个字符无需编码。
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/?#@!$&amp;&#39;()*&#43;,;_-.~
对于需要编码的字符，百分号编码方案要求 ASCII 字符表示成两个 16 进制值并添加前缀 %；对于非 ASCII 字符, 需要转换为 UTF-8 字节序, 然后每个字节按照上述方式表示成两个 16 进制值并添加前缀 %。比如 | 将被表示为 %7C 或 %7c（大小写无关）；啊 将被表示为 %E5%95%8A。
最近因为 Tomcat 版本升级，遭遇了非标到标准实现的过渡，新版本 Tomcat 严格执行 RFC 规范直接将非标准的 URI 请求强制拒绝。
2020-07-15 16:02:12,931  INFO 1 --- [http-nio-8080-exec-7] o.a.c.h.Http11Processor                  : Error parsing HTTP request header
 Note: further occurrences of HTTP request parsing errors will be logged at DEBUG level.
java.lang.IllegalArgumentException: Invalid character found in the request target. The valid characters are defined in RFC 7230 and RFC 3986
        at org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:468) ~[tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:294) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]
" />
  <meta name="description" content="RFC 7230 与 RFC 3986 定义了 HTTP/1.1 标准并对 URI 的编解码问题作出了规范。但是，文本形式的规范和最终落地的标准之间总是存在着差距。标准中共 82 个字符无需编码。
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/?#@!$&amp;&#39;()*&#43;,;_-.~
对于需要编码的字符，百分号编码方案要求 ASCII 字符表示成两个 16 进制值并添加前缀 %；对于非 ASCII 字符, 需要转换为 UTF-8 字节序, 然后每个字节按照上述方式表示成两个 16 进制值并添加前缀 %。比如 | 将被表示为 %7C 或 %7c（大小写无关）；啊 将被表示为 %E5%95%8A。
最近因为 Tomcat 版本升级，遭遇了非标到标准实现的过渡，新版本 Tomcat 严格执行 RFC 规范直接将非标准的 URI 请求强制拒绝。
2020-07-15 16:02:12,931  INFO 1 --- [http-nio-8080-exec-7] o.a.c.h.Http11Processor                  : Error parsing HTTP request header
 Note: further occurrences of HTTP request parsing errors will be logged at DEBUG level.
java.lang.IllegalArgumentException: Invalid character found in the request target. The valid characters are defined in RFC 7230 and RFC 3986
        at org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:468) ~[tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:294) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]
" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/index.css">

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  
  
</head>

     
  </head>
  <body>
    
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">URI不规范编码解决方案</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2020-07-25 00:00:00 UTC">
                25 Jul 2020
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <p><a href="https://tools.ietf.org/rfc/rfc7230.txt">RFC 7230</a> 与 <a href="https://tools.ietf.org/rfc/rfc3986.txt">RFC 3986</a> 定义了 HTTP/1.1 标准并对 URI 的编解码问题作出了规范。但是，文本形式的规范和最终落地的标准之间总是存在着差距。标准中共 82 个字符无需编码。</p>
<pre><code>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/?#@!$&amp;'()*+,;_-.~
</code></pre><p>对于需要编码的字符，百分号编码方案要求 ASCII 字符表示成两个 16 进制值并添加前缀 <code>%</code>；对于非 ASCII 字符, 需要转换为 UTF-8 字节序, 然后每个字节按照上述方式表示成两个 16 进制值并添加前缀 <code>%</code>。比如 <code>|</code> 将被表示为 <code>%7C</code> 或 <code>%7c</code>（大小写无关）；<code>啊</code> 将被表示为 <code>%E5%95%8A</code>。</p>
<p>最近因为 Tomcat 版本升级，遭遇了非标到标准实现的过渡，新版本 Tomcat 严格执行 RFC 规范直接将非标准的 URI 请求强制拒绝。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">2020-07-15 16:02:12,931  INFO 1 --- [http-nio-8080-exec-7] o.a.c.h.Http11Processor                  : Error parsing HTTP request header
 Note: further occurrences of HTTP request parsing errors will be logged at DEBUG level.
java.lang.IllegalArgumentException: Invalid character found in the request target. The valid characters are defined in RFC 7230 and RFC 3986
        at org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:468) ~[tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:294) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) [tomcat-embed-core-9.0.22.jar!/:9.0.22]
        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]
</code></pre></div><h2 id="tomcat-侧解决方案">Tomcat 侧解决方案</h2>
<p>由于是 Tomcat 升级带来的问题，回退版本是最简单但无奈的选择。但这不是理想的解决方案。</p>
<p>Tomcat 为了兼容非标准实现的浏览器请求编码，额外释出了两个配置选项 <code>RelaxedPathChars</code> / <code>relaxedQueryChars</code> 分别用于对 URI Paths 和 URI Query 放松限制。通过配置 <code>server.xml</code> 的 <code>Connector</code> 允许自定义放过 <code>&quot; &lt; &gt; [ \ ] ^ \</code> { | }` 中的一种或多种字符。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#062873;font-weight:bold">&lt;Connector</span> 
    <span style="color:#4070a0">connectionTimeout=</span><span style="color:#4070a0">&#34;20000&#34;</span> 
    <span style="color:#4070a0">port=</span><span style="color:#4070a0">&#34;8080&#34;</span> 
    <span style="color:#4070a0">protocol=</span><span style="color:#4070a0">&#34;HTTP/1.1&#34;</span> 
    <span style="color:#4070a0">redirectPort=</span><span style="color:#4070a0">&#34;8443&#34;</span> 
    <span style="color:#4070a0">relaxedQueryChars=</span><span style="color:#4070a0">&#39;^{}[]|&#39;</span> 
    <span style="color:#4070a0">relaxedPathChars=</span><span style="color:#4070a0">&#39;{}&#39;</span>
<span style="color:#062873;font-weight:bold">/&gt;</span>
</code></pre></div><p>至于 Spring Boot 内嵌的 Tomcat 容器，可以通过主动声明 Web 服务器工厂实例来配置</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#555;font-weight:bold">@Bean</span>
<span style="color:#007020;font-weight:bold">public</span> ConfigurableServletWebServerFactory <span style="color:#06287e">webServerFactory</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    TomcatServletWebServerFactory factory <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> TomcatServletWebServerFactory<span style="color:#666">();</span>
    factory<span style="color:#666">.</span><span style="color:#4070a0">addConnectorCustomizers</span><span style="color:#666">(</span>connector <span style="color:#666">-&gt;</span> <span style="color:#666">{</span>
        connector<span style="color:#666">.</span><span style="color:#4070a0">setProperty</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;relaxedPathChars&#34;</span><span style="color:#666">,</span> <span style="color:#4070a0">&#34;[]|&#34;</span><span style="color:#666">);</span>       <span style="color:#60a0b0;font-style:italic">// 添加需要的特殊符号
</span><span style="color:#60a0b0;font-style:italic"></span>        connector<span style="color:#666">.</span><span style="color:#4070a0">setProperty</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;relaxedQueryChars&#34;</span><span style="color:#666">,</span> <span style="color:#4070a0">&#34;|{}[]&#34;</span><span style="color:#666">);</span>    <span style="color:#60a0b0;font-style:italic">// 添加需要的特殊符号
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#666">});</span>
    <span style="color:#007020;font-weight:bold">return</span> factory<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><h2 id="反向代理服务器-nginx-侧解决方案">反向代理服务器 NGINX 侧解决方案</h2>
<p>Tomcat 在新版本中限制部分未编码字符的使用，是为了解决 HTTP 请求走私漏洞。放松对此类字符的限制无疑是主动交出大门钥匙。</p>
<p>浏览器的非标准实现方案无法规避。但对于我们现有的部署架构，NGINX 作为最外侧的服务，提供反向代理。在 NGINX 侧可以将非标 HTTP 请求标准化。</p>
<p>由于 NGINX rewrite 模块对特定字符全量替换支持度不足，引入了 Lua 模块来实现对特定字符 <code>|</code> 的编码处理，其他字符也可采用类似的方式来解决。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">location / {
    rewrite_by_lua_block {
        local escape_args = string.gsub(ngx.var.args, &#34;|&#34;, &#34;%%7C&#34;)
        ngx.req.set_uri_args(escape_args)
    }

    proxy_pass http://k8s;
}
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-category">
              <a href="/categories/%e6%8a%80%e6%9c%af/">
                技术
              </a>
            </div>
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

<div class="releated-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2020-05-23-uri/">URI 与资源定义</a></li>
    
  </ul>
</div>

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/posts/" target="_blank">Posts</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
   
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

 
  </body>
</html>
