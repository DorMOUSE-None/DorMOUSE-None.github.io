<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2018-07-13-%E5%A6%82%E4%BD%95%E6%96%B9%E4%BE%BF%E5%9C%B0%E8%8E%B7%E5%8F%96-cglib-%E7%94%9F%E6%88%90%E7%B1%BB/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2018-07-13-%E5%A6%82%E4%BD%95%E6%96%B9%E4%BE%BF%E5%9C%B0%E8%8E%B7%E5%8F%96-cglib-%E7%94%9F%E6%88%90%E7%B1%BB/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/www.ffutop.com\/"
      },
      "articleSection" : "posts",
      "name" : "如何方便地获取 CGlib 生成类",
      "headline" : "如何方便地获取 CGlib 生成类",
      "description" : "\x3ch2 id=\x22配置参数\x22\x3e配置参数\x3c\/h2\x3e\n\x3cp\x3e\x3cstrong\x3e命令行使用\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e在 java 启动命令中添加参数配置项 \x3ccode\x3e-Dcglib.debugLocation=\x26lt;Custom Path\x26gt;\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e\x3cstrong\x3e编码实现\x3c\/strong\x3e\x3c\/p\x3e\n\x3cp\x3e在执行 CGlib 获取新生成类之前，调用 \x3ccode\x3eSystem.setProperty(\x26quot;cglib.debugLocation\x26quot;, \x26lt;Custom Path\x26gt;)\x3c\/code\x3e\x3c\/p\x3e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2018",
      "datePublished": "2018-07-13 00:00:00 \x2b0000 UTC",
      "dateModified" : "2018-07-13 00:00:00 \x2b0000 UTC",
      "url" : "https:\/\/www.ffutop.com\/posts\/2018-07-13-%E5%A6%82%E4%BD%95%E6%96%B9%E4%BE%BF%E5%9C%B0%E8%8E%B7%E5%8F%96-cglib-%E7%94%9F%E6%88%90%E7%B1%BB\/",
      "keywords" : [ "CGlib","tools", ]
  }
</script>
<title>如何方便地获取 CGlib 生成类 - Utop&#39;s Blog</title>
  <meta property="og:title" content="如何方便地获取 CGlib 生成类 - Utop&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="配置参数
命令行使用
在 java 启动命令中添加参数配置项 -Dcglib.debugLocation=&lt;Custom Path&gt;
编码实现
在执行 CGlib 获取新生成类之前，调用 System.setProperty(&quot;cglib.debugLocation&quot;, &lt;Custom Path&gt;)" />
  <meta name="description" content="配置参数
命令行使用
在 java 启动命令中添加参数配置项 -Dcglib.debugLocation=&lt;Custom Path&gt;
编码实现
在执行 CGlib 获取新生成类之前，调用 System.setProperty(&quot;cglib.debugLocation&quot;, &lt;Custom Path&gt;)" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/github-markdown.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-92258941-1"></script>
</head>


<body>
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">如何方便地获取 CGlib 生成类</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2018-07-13 00:00:00 UTC">
                13 Jul 2018
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="配置参数">配置参数</h2>
<p><strong>命令行使用</strong></p>
<p>在 java 启动命令中添加参数配置项 <code>-Dcglib.debugLocation=&lt;Custom Path&gt;</code></p>
<p><strong>编码实现</strong></p>
<p>在执行 CGlib 获取新生成类之前，调用 <code>System.setProperty(&quot;cglib.debugLocation&quot;, &lt;Custom Path&gt;)</code></p>
<h2 id="如何游刃有余地-debug-掺杂-cglib-生成类的调用链">如何游刃有余地 Debug 掺杂 CGlib 生成类的调用链</h2>
<p>经常会遇到，项目中不经意间就遇到了 CGlib 代理，然后对调用链的 Debug 就开始出现断层。继而，对对象或实例变量的跟踪就显得一头雾水。</p>
<p>特别是在不了解生成类到底是增强了那些内容的时候，甚至可能连调用链都跟踪不下去了 T_T 。</p>
<p>通过 <strong>配置参数</strong> 一节的内容，你就可以在你理想的目录 <code>&lt;Custom Path&gt;</code> 下看到<strong>所谓黑盒</strong>中生成类的完成内容了。</p>
<p>下面的内容，将简单地介绍如何配合 CGlib 生成类的内容实现: 保证 Debug 的每一步骤可见; 保证 Debug 的过程不会出现<em>黑盒</em>。</p>
<h3 id="确定-custom-path-下哪个文件是原有-java-类的生成类">确定 <code>&lt;Custom Path&gt;</code> 下哪个文件是原有 Java 类的生成类</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getClassName</span><span style="color:#f92672">(</span>String prefix<span style="color:#f92672">,</span> String source<span style="color:#f92672">,</span> Object key<span style="color:#f92672">,</span> Predicate names<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prefix <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;net.sf.cglib.empty.Object&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prefix<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;java&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$&#34;</span> <span style="color:#f92672">+</span> prefix<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    String base <span style="color:#f92672">=</span>
        prefix <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;$$&#34;</span> <span style="color:#f92672">+</span>
        source<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>source<span style="color:#f92672">.</span><span style="color:#a6e22e">lastIndexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">+</span>
        getTag<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;$$&#34;</span> <span style="color:#f92672">+</span>
        Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">toHexString</span><span style="color:#f92672">(</span>STRESS_HASH_CODE <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> key<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
    String attempt <span style="color:#f92672">=</span> base<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>names<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>attempt<span style="color:#f92672">))</span>
        attempt <span style="color:#f92672">=</span> base <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> index<span style="color:#f92672">++;</span>
    <span style="color:#66d9ef">return</span> attempt<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>CGlib 默认的类名生成策略下，生成类的全限定名将结合原文件的全限定名决定。</p>
<p>通常命名如下: <code>&lt;原 Java 类全限定名&gt;$$&lt;类似 EnhancerByCGlib&gt;$$&lt;生成类核心内容的 hash 值&gt;_&lt;index[可能存在]&gt;</code></p>
<p>例如: 原有 Java 类全限定名为 me.fangfeng.Test ，则生成类名可能为 <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code></p>
<p>当然，通常情况下会存在一个类名形如 <code>me.fangfeng.Test$$FastClassBySpring$$...</code> 的类，这是作为生成类 <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code> 的辅助类来使用。</p>
<h3 id="简单了解生成类下的调用关系">简单了解生成类下的调用关系</h3>
<p>Java 代码触发被增强的类，将首先调用生成类。但是，这是没办法进行 Debug 的，因为这个生成类的字节码缺少 SourceFile 属性，同时缺少 LineNumberTable 属性。</p>
<p>但是，这并不影响对调用链的跟踪。</p>
<p>CGlib 的增强，所有的增强逻辑都是以 Callback 实现类的形式来提供的。同时在 CGlib 生成类中也有 Callback 的实例变量来持有这些注入的 Callback 。</p>
<p><strong>原有 Java 类</strong></p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8e7kr7qvj30sc0j0wh4.jpg" alt="LogonService.java"></p>
<p><strong>对应的生成类</strong></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8e9ww4hqj31hg0oojzv.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eanb6c9j31j00lgn1e.jpg" alt=""></p>
<p><strong>跟踪 LogonService.addLogon(String var1) 演示</strong></p>
<p>当前 LogonService 的生成类全限定名为me.fangfeng.transactionBugs.LogonService$$EnhancerBySpringCGLIB$$bfc1dc3.class; 以下简称为 LogonSerivce$$bfc1dc3</p>
<ol>
<li>
<p>首先，配置 <code>cglib.debugLocation</code> 参数，值 = 项目生成的 .class 路径</p>
</li>
<li>
<p>无断点直接运行一次需要处理的逻辑</p>
</li>
<li>
<p>找到 LogonSerive$$bfc1dc3.class, 随意打上一个看似有效的断点</p>
</li>
<li>
<p>在各处打上必要的断点，开始进行真正的调试工作</p>
</li>
<li>
<p>代码执行到 LogonService$$bfc1dc3.class, 虽然没有真正进入断点位置, 但是可以看到这个 LogonService$$bfc1dc3 实例的实例变量信息</p>
</li>
</ol>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8eq1be61j319w0bwtde.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8egtg1naj31ji0fmgp2.jpg" alt=""></p>
<p>比照生成类代码中 addLogon(String var1) 方法体的内容以及展示的实例变量信息。可以看到生成类调用的 Callback 实例是 <code>CGLIB$CALLBACK_0</code>
类型是 CglibAopProxy 的静态内部私有类 DynamicAdvisedInterceptor 。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eu91oscj31gq0ayju5.jpg" alt=""></p>
<p>在 intercept(&hellip;) 上打个断点，跳过生成类 addLogon(String var1) 方法的下一个调用方法就是 intercept(&hellip;)</p>
<p><strong>而且事实上，CGlib 生成类的内容基本也就是对调用方法进行的一种转发</strong></p>
<ol start="6">
<li>继续 Debug ，对于生成类的内容，人肉了解并定位到触发的 Callback 实例或者 super.Xxx() 方法。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

<div class="releated-content">
  <h3>Related Posts</h3>
  <ul>
    
    <li><a href="/posts/2018-07-10-cglib-enhancer-%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">CGlib Enhancer 主流程源码解析</a></li>
    
  </ul>
</div>

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

</body>

</html>
