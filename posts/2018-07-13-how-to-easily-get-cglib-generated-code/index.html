<!DOCTYPE html>
<html lang="zh-cn">
<head>
  
    <title>如何方便地获取 CGlib 生成类 :: Utop&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="配置参数 命令行使用
在 java 启动命令中添加参数配置项 -Dcglib.debugLocation=&amp;lt;Custom Path&amp;gt;
编码实现
在执行 CGlib 获取新生成类之前，调用 System.setProperty(&amp;quot;cglib.debugLocation&amp;quot;, &amp;lt;Custom Path&amp;gt;)
"/>
<meta name="keywords" content="BLOG"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://dormouse-none.github.io/posts/2018-07-13-how-to-easily-get-cglib-generated-code/" />


<link rel="stylesheet" href="https://dormouse-none.github.io/assets/style.css">

  <link rel="stylesheet" href="https://dormouse-none.github.io/assets/blue.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://dormouse-none.github.io/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="https://dormouse-none.github.io/favicon.ico">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="如何方便地获取 CGlib 生成类 :: Utop&#39;s Blog — " />
<meta name="twitter:description" content="配置参数 命令行使用
在 java 启动命令中添加参数配置项 -Dcglib.debugLocation=&amp;lt;Custom Path&amp;gt;
编码实现
在执行 CGlib 获取新生成类之前，调用 System.setProperty(&amp;quot;cglib.debugLocation&amp;quot;, &amp;lt;Custom Path&amp;gt;)
" />
<meta name="twitter:site" content="https://dormouse-none.github.io/" />
<meta name="twitter:creator" content="fangfeng" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="zh-cn" />
<meta property="og:type" content="article" />
<meta property="og:title" content="如何方便地获取 CGlib 生成类 :: Utop&#39;s Blog — ">
<meta property="og:description" content="配置参数 命令行使用
在 java 启动命令中添加参数配置项 -Dcglib.debugLocation=&amp;lt;Custom Path&amp;gt;
编码实现
在执行 CGlib 获取新生成类之前，调用 System.setProperty(&amp;quot;cglib.debugLocation&amp;quot;, &amp;lt;Custom Path&amp;gt;)
" />
<meta property="og:url" content="https://dormouse-none.github.io/posts/2018-07-13-how-to-easily-get-cglib-generated-code/" />
<meta property="og:site_name" content="如何方便地获取 CGlib 生成类" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2018-07-13 00:00:00 &#43;0000 UTC" />











</head>
<body class="">


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    ffutop
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">关于</a></li>
        
      
        
          <li><a href="/archives">归档</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">关于</a></li>
      
    
      
        <li><a href="/archives">归档</a></li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://dormouse-none.github.io/posts/2018-07-13-how-to-easily-get-cglib-generated-code/">如何方便地获取 CGlib 生成类</a></h1>
  <div class="post-meta">
      
    <span class="post-date">
      2018-07-13
    </span>
    
    
    <span class="post-author">::
      fangfeng
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://dormouse-none.github.io/tags/cglib/">CGlib</a>&nbsp;
    
    #<a href="https://dormouse-none.github.io/tags/tools/">tools</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    <h2 id="配置参数">配置参数</h2>

<p><strong>命令行使用</strong></p>

<p>在 java 启动命令中添加参数配置项 <code>-Dcglib.debugLocation=&lt;Custom Path&gt;</code></p>

<p><strong>编码实现</strong></p>

<p>在执行 CGlib 获取新生成类之前，调用 <code>System.setProperty(&quot;cglib.debugLocation&quot;, &lt;Custom Path&gt;)</code></p>

<h2 id="如何游刃有余地-debug-掺杂-cglib-生成类的调用链">如何游刃有余地 Debug 掺杂 CGlib 生成类的调用链</h2>

<p>经常会遇到，项目中不经意间就遇到了 CGlib 代理，然后对调用链的 Debug 就开始出现断层。继而，对对象或实例变量的跟踪就显得一头雾水。</p>

<p>特别是在不了解生成类到底是增强了那些内容的时候，甚至可能连调用链都跟踪不下去了 T_T 。</p>

<p>通过 <strong>配置参数</strong> 一节的内容，你就可以在你理想的目录 <code>&lt;Custom Path&gt;</code> 下看到<strong>所谓黑盒</strong>中生成类的完成内容了。</p>

<p>下面的内容，将简单地介绍如何配合 CGlib 生成类的内容实现: 保证 Debug 的每一步骤可见; 保证 Debug 的过程不会出现*黑盒*。</p>

<h3 id="确定-custom-path-下哪个文件是原有-java-类的生成类">确定 <code>&lt;Custom Path&gt;</code> 下哪个文件是原有 Java 类的生成类</h3>

<pre><code class="language-java">public String getClassName(String prefix, String source, Object key, Predicate names) {
    if (prefix == null) {
        prefix = &quot;net.sf.cglib.empty.Object&quot;;
    } else if (prefix.startsWith(&quot;java&quot;)) {
        prefix = &quot;$&quot; + prefix;
    }
    String base =
        prefix + &quot;$$&quot; +
        source.substring(source.lastIndexOf('.') + 1) +
        getTag() + &quot;$$&quot; +
        Integer.toHexString(STRESS_HASH_CODE ? 0 : key.hashCode());
    String attempt = base;
    int index = 2;
    while (names.evaluate(attempt))
        attempt = base + &quot;_&quot; + index++;
    return attempt;
}
</code></pre>

<p>CGlib 默认的类名生成策略下，生成类的全限定名将结合原文件的全限定名决定。</p>

<p>通常命名如下: <code>&lt;原 Java 类全限定名&gt;$$&lt;类似 EnhancerByCGlib&gt;$$&lt;生成类核心内容的 hash 值&gt;_&lt;index[可能存在]&gt;</code></p>

<p>例如: 原有 Java 类全限定名为 me.fangfeng.Test ，则生成类名可能为 <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code></p>

<p>当然，通常情况下会存在一个类名形如 <code>me.fangfeng.Test$$FastClassBySpring$$...</code> 的类，这是作为生成类 <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code> 的辅助类来使用。</p>

<h3 id="简单了解生成类下的调用关系">简单了解生成类下的调用关系</h3>

<p>Java 代码触发被增强的类，将首先调用生成类。但是，这是没办法进行 Debug 的，因为这个生成类的字节码缺少 SourceFile 属性，同时缺少 LineNumberTable 属性。</p>

<p>但是，这并不影响对调用链的跟踪。</p>

<p>CGlib 的增强，所有的增强逻辑都是以 Callback 实现类的形式来提供的。同时在 CGlib 生成类中也有 Callback 的实例变量来持有这些注入的 Callback 。</p>

<p><strong>原有 Java 类</strong></p>

<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8e7kr7qvj30sc0j0wh4.jpg" alt="LogonService.java" /></p>

<p><strong>对应的生成类</strong></p>

<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8e9ww4hqj31hg0oojzv.jpg" alt="" /></p>

<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eanb6c9j31j00lgn1e.jpg" alt="" /></p>

<p><strong>跟踪 LogonService.addLogon(String var1) 演示</strong></p>

<p>当前 LogonService 的生成类全限定名为me.fangfeng.transactionBugs.LogonService$$EnhancerBySpringCGLIB$$bfc1dc3.class; 以下简称为 LogonSerivce$$bfc1dc3</p>

<ol>
<li><p>首先，配置 <code>cglib.debugLocation</code> 参数，值 = 项目生成的 .class 路径</p></li>

<li><p>无断点直接运行一次需要处理的逻辑</p></li>

<li><p>找到 LogonSerive$$bfc1dc3.class, 随意打上一个看似有效的断点</p></li>

<li><p>在各处打上必要的断点，开始进行真正的调试工作</p></li>

<li><p>代码执行到 LogonService$$bfc1dc3.class, 虽然没有真正进入断点位置, 但是可以看到这个 LogonService$$bfc1dc3 实例的实例变量信息</p></li>
</ol>

<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8eq1be61j319w0bwtde.jpg" alt="" /></p>

<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8egtg1naj31ji0fmgp2.jpg" alt="" /></p>

<p>比照生成类代码中 addLogon(String var1) 方法体的内容以及展示的实例变量信息。可以看到生成类调用的 Callback 实例是 <code>CGLIB$CALLBACK_0</code>
类型是 CglibAopProxy 的静态内部私有类 DynamicAdvisedInterceptor 。</p>

<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eu91oscj31gq0ayju5.jpg" alt="" /></p>

<p>在 intercept(&hellip;) 上打个断点，跳过生成类 addLogon(String var1) 方法的下一个调用方法就是 intercept(&hellip;)</p>

<p><strong>而且事实上，CGlib 生成类的内容基本也就是对调用方法进行的一种转发</strong></p>

<ol>
<li>继续 Debug ，对于生成类的内容，人肉了解并定位到触发的 Callback 实例或者 super.Xxx() 方法。</li>
</ol>

<pre><code class="language-plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | '_ \ / _` | |_ / _ \ '_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre>
  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://dormouse-none.github.io/posts/2018-07-20-java-proxy/">
          <span class="button__icon">←</span>
          <span class="button__text">Java Proxy 源码解析</span>
        </a>
      </span>
      
      
      <span class="button next">
        <a href="https://dormouse-none.github.io/posts/2018-07-10-cglib-enhancer/">
          <span class="button__text">CGlib Enhancer 主流程源码解析</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>2018-2019 © ffutop</span>
        <span>:: Powered by <a href="http://gohugo.io">Hugo</a></span>
      </div>
    
  </div>
</footer>

<script src="https://dormouse-none.github.io/assets/main.js"></script>
<script src="https://dormouse-none.github.io/assets/prism.js"></script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>






  
</div>

</body>
</html>
