<!DOCTYPE html>
<html lang="zh-cmn-Hans-CN" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    
    <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.68.3" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ffutop" />
  <meta property="og:url" content="https://www.ffutop.com/posts/2018-11-16-regex-exponential-explosion/" />
  <link rel="canonical" href="https://www.ffutop.com/posts/2018-11-16-regex-exponential-explosion/" /><link rel="apple-touch-icon" href="favicon.ico" />
  <link rel="icon" href="favicon.ico" />
  <link rel="shortcut" href="favicon.ico" /><link rel="alternate" type="application/atom+xml" href="https://www.ffutop.com/index.xml" title="Utop&#39;s Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.ffutop.com/"
      },
      "articleSection" : "posts",
      "name" : "正则表达式指数爆炸",
      "headline" : "正则表达式指数爆炸",
      "description" : "\u003ch2 id=\"背景\"\u003e背景\u003c/h2\u003e\n\u003cp\u003e昨天接触到一个很有意思的问题, 公司测试环境一台机器 CPU 跑到了 400%，导致该机器上的所有服务都挂掉了。\u003c/p\u003e\n\u003cp\u003e最后查到的原因竟然是正则表达式所引起的，大大出乎意料啊。虽然早就知道正则效率很差，但绝对没有想到会导致整个机器上服务崩溃的情况。\u003c/p\u003e\n\u003cp\u003e先简单展示下问题正则:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003eString regex \u003cspan style=\"color:#666\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#4070a0\"\u003e\u0026#34;(\\\\w+,?)+\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#666\"\u003e;\u003c/span\u003e\nString val \u003cspan style=\"color:#666\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#4070a0\"\u003e\u0026#34;abcdefghijklmno,abcdefghijklmno+\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#666\"\u003e;\u003c/span\u003e\nSystem\u003cspan style=\"color:#666\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#4070a0\"\u003eout\u003c/span\u003e\u003cspan style=\"color:#666\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#4070a0\"\u003eprintln\u003c/span\u003e\u003cspan style=\"color:#666\"\u003e(\u003c/span\u003eval\u003cspan style=\"color:#666\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#4070a0\"\u003ematches\u003c/span\u003e\u003cspan style=\"color:#666\"\u003e(\u003c/span\u003eregex\u003cspan style=\"color:#666\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最终的执行时间是 17s 左右。\u003c/p\u003e\n\u003cp\u003e相反，如果改成 \u003ccode\u003eString val = \u0026quot;abcdefghijklmno,abcdefghijklmno\u0026quot;\u003c/code\u003e ，实际执行时间 1ms 左右。\u003c/p\u003e\n\u003cp\u003e哈哈，完全不是一个量级的结果。\u003c/p\u003e\n\u003cp\u003e最后，当然是要找原因了:\u0026lt; 当然，有其它重要的事在耽搁，没时间去看 Java Regex 源码。不过，从正则本身下手反而是个好事情。毕竟几乎所有的编程语言都有对正则的支持。而同样的，都存在着这样的问题。那就可以大胆猜想其实是和语言本身无关，而在于正则规范本身了。\u003c/p\u003e\n\u003cp\u003e先给个结果，罪魁祸首就是\u003ccode\u003e指数爆炸\u003c/code\u003e\u003c/p\u003e",
      "inLanguage" : "zh-cmn-Hans-CN",
      "author" : "ffutop",
      "creator" : "ffutop",
      "publisher": "ffutop",
      "accountablePerson" : "ffutop",
      "copyrightHolder" : "ffutop",
      "copyrightYear" : "2018",
      "datePublished": "2018-11-16T00:00:00Z",
      "dateModified" : "2018-11-16T00:00:00Z",
      "url" : "https://www.ffutop.com/posts/2018-11-16-regex-exponential-explosion/",
      "keywords" : [ "regular expression","指数爆炸", ]
  }
</script>
<title>正则表达式指数爆炸</title>
  <meta property="og:title" content="正则表达式指数爆炸" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="背景
昨天接触到一个很有意思的问题, 公司测试环境一台机器 CPU 跑到了 400%，导致该机器上的所有服务都挂掉了。
最后查到的原因竟然是正则表达式所引起的，大大出乎意料啊。虽然早就知道正则效率很差，但绝对没有想到会导致整个机器上服务崩溃的情况。
先简单展示下问题正则:
String regex = &#34;(\\w&#43;,?)&#43;&#34;;
String val = &#34;abcdefghijklmno,abcdefghijklmno&#43;&#34;;
System.out.println(val.matches(regex));
最终的执行时间是 17s 左右。
相反，如果改成 String val = &quot;abcdefghijklmno,abcdefghijklmno&quot; ，实际执行时间 1ms 左右。
哈哈，完全不是一个量级的结果。
最后，当然是要找原因了:&lt; 当然，有其它重要的事在耽搁，没时间去看 Java Regex 源码。不过，从正则本身下手反而是个好事情。毕竟几乎所有的编程语言都有对正则的支持。而同样的，都存在着这样的问题。那就可以大胆猜想其实是和语言本身无关，而在于正则规范本身了。
先给个结果，罪魁祸首就是指数爆炸" />
  <meta name="description" content="背景
昨天接触到一个很有意思的问题, 公司测试环境一台机器 CPU 跑到了 400%，导致该机器上的所有服务都挂掉了。
最后查到的原因竟然是正则表达式所引起的，大大出乎意料啊。虽然早就知道正则效率很差，但绝对没有想到会导致整个机器上服务崩溃的情况。
先简单展示下问题正则:
String regex = &#34;(\\w&#43;,?)&#43;&#34;;
String val = &#34;abcdefghijklmno,abcdefghijklmno&#43;&#34;;
System.out.println(val.matches(regex));
最终的执行时间是 17s 左右。
相反，如果改成 String val = &quot;abcdefghijklmno,abcdefghijklmno&quot; ，实际执行时间 1ms 左右。
哈哈，完全不是一个量级的结果。
最后，当然是要找原因了:&lt; 当然，有其它重要的事在耽搁，没时间去看 Java Regex 源码。不过，从正则本身下手反而是个好事情。毕竟几乎所有的编程语言都有对正则的支持。而同样的，都存在着这样的问题。那就可以大胆猜想其实是和语言本身无关，而在于正则规范本身了。
先给个结果，罪魁祸首就是指数爆炸" />
  <meta property="og:locale" content="zh-cmn-Hans-CN" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/index.css">

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="Utop&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  
  
</head>

     
  </head>
  <body>
    
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">FFUTOP</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">正则表达式指数爆炸</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2018-11-16 00:00:00 UTC">
                16 Nov 2018
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="https://www.ffutop.com/">@ffutop</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <h2 id="背景">背景</h2>
<p>昨天接触到一个很有意思的问题, 公司测试环境一台机器 CPU 跑到了 400%，导致该机器上的所有服务都挂掉了。</p>
<p>最后查到的原因竟然是正则表达式所引起的，大大出乎意料啊。虽然早就知道正则效率很差，但绝对没有想到会导致整个机器上服务崩溃的情况。</p>
<p>先简单展示下问题正则:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">String regex <span style="color:#666">=</span> <span style="color:#4070a0">&#34;(\\w+,?)+&#34;</span><span style="color:#666">;</span>
String val <span style="color:#666">=</span> <span style="color:#4070a0">&#34;abcdefghijklmno,abcdefghijklmno+&#34;</span><span style="color:#666">;</span>
System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span>val<span style="color:#666">.</span><span style="color:#4070a0">matches</span><span style="color:#666">(</span>regex<span style="color:#666">));</span>
</code></pre></div><p>最终的执行时间是 17s 左右。</p>
<p>相反，如果改成 <code>String val = &quot;abcdefghijklmno,abcdefghijklmno&quot;</code> ，实际执行时间 1ms 左右。</p>
<p>哈哈，完全不是一个量级的结果。</p>
<p>最后，当然是要找原因了:&lt; 当然，有其它重要的事在耽搁，没时间去看 Java Regex 源码。不过，从正则本身下手反而是个好事情。毕竟几乎所有的编程语言都有对正则的支持。而同样的，都存在着这样的问题。那就可以大胆猜想其实是和语言本身无关，而在于正则规范本身了。</p>
<p>先给个结果，罪魁祸首就是<code>指数爆炸</code></p>
<h2 id="追本溯源">追本溯源</h2>
<p>这里并不准备一步一步地阐述正则的，如果真的是零基础的话，推荐先看一下 <a href="https://github.com/ziishaned/learn-regex/blob/master/README-cn.md">学习正则</a></p>
<p>就事论事，还是以 <code>regex ::= (\w+,?)+</code> 作为示例来进行说明。</p>
<p>首先需要了解的是 <code>val.matches(regex)</code> 所要进行的工作是判断 <code>val</code> 全串是否符合 <code>regex</code> 正则模式。而正则所要做的工作就是尝试所有的匹配可能性(当然，对于 <code>val</code> 这个串来说，最后匹配到 <code>abcd..,abcd..mno+</code> 的 <code>+</code> 的时候一定是失败的，因为 <code>regex</code> 并不匹配 <code>+</code>)</p>
<p>简单扩展一下对<code>尝试所有匹配可能性</code>这句话的描述:</p>
<p>我们以 <code>()</code> 对应 <code>regex</code> 中的一组 <code>(\w+,?)</code> ，而最后一个 <code>+</code> 表示一个或多个(即允许存在多个<code>()</code>)</p>
<p>对 <code>val</code> 串的匹配可能性有</p>
<ul>
<li>
<p>(abcdefghijklmno,)(abcdefghijklmno)+</p>
</li>
<li>
<p>(abcd)(efghijklmno,)(abcdefghijklmno)+</p>
</li>
<li>
<p>(abcdefghijklmno,)(abcdef)(ghijklmno)+</p>
</li>
<li>
<p>(abc)(defghijklmno,)(abcde)(fg)(hijklmno)+</p>
</li>
<li>
<p>&hellip;</p>
</li>
</ul>
<p>有相当多的匹配可能，不再一一详述(事实上，光靠个人手工根本列举不完。</p>
<p>那么到底会有多少中匹配可能性呢?</p>
<p>下面我们就来简单计算一下:</p>
<p>首先，我们把 <code>(\w+,?)+</code> 这个正则扩展一下，它与下列这些串都是等价的 <code>(\w+,|\w+)+</code>, <code>(\w+,)?(\w+)?(\w+,?)+</code>, <code>(\w+,)?(\w+)?(\w+)?(\w+,?)+</code> &hellip;</p>
<p>也就是说，我们能够至少把 <code>abcdefghijklmno,abcdefghijklmno+</code> 按照匹配串划分出1组，2组，3组&hellip;30组(因为每个组至少需要一个<code>\w</code> )</p>
<p>不过这个按照1组，2组&hellip;去计算可能性的话实在是费力不讨好的事情。用组合数学来考虑这个问题</p>
<p>首先，整个 <code>abcdefghijklmno,abcdefghijklmno+</code> 的开始应该有一个左括号 <code>(</code>，即 <code>(abcdefghijklmno,abcdefghijklmno+</code></p>
<p>其次，到 <code>,</code> 为止至少应该有一个右左括号 <code>)(</code>，即 <code>(abcdefghijklmno,)(abcdefghijklmno+</code></p>
<p>再次，由于到 <code>o+</code> 为止一定匹配失败，因此，<code>+</code> 之前应该有一个 <code>)</code>, 即 <code>(abcdefghijklmno,)(abcdefghijklmno)+</code></p>
<p>至于其他字符间的空隙，除了 <code>o,</code> 之间不能存在右左括号 <code>)(</code> ，其他字符间都可以随意插入 <code>)(</code> (至于为什么是右左括号，表示前一个组的结束与新的组的开始)</p>
<p>那么总共有多少种可能?</p>
<ul>
<li>
<p>插入零个右左括号 <code>)(</code> , $C_{28}^0$ = 1 种可行方案</p>
</li>
<li>
<p>插入一个右左括号 <code>)(</code> , $C_{28}^1$ = 28 种可行方案 (总共 28 个可用字符间隙)</p>
</li>
<li>
<p>插入两个右左括号 <code>)(</code> , $C_{28}^2$ 种可行方案</p>
</li>
<li>
<p>&hellip;</p>
</li>
<li>
<p>插入28个右左括号 <code>)(</code> , $C_{28}^{28}$ 种可行方案</p>
</li>
</ul>
<p>累加的结果为 $C_{28}^1 + C_{28}^2 + C_{28}^3 + &hellip; + C_{28}^{28} = 2^{28}$</p>
<p>可想而知为什么会花 17s 了吧。毕竟达到了 2500 万以上的计算量级，加上 regex 本身就是偏慢的。</p>
<p>至于为什么把 <code>abcdefghijklmno,abcdefghijklmno+</code> 串的 <code>+</code> 去掉就变快了？理由也很简单，<code>matches(regex)</code> 在正则串与原串匹配上之后就会快速结束，因为结果只需要告知某次匹配成功了即可。而失败的匹配会不断地尝试所有的可能性。</p>
<h2 id="解决方案">解决方案</h2>
<p>至于解决方案，从上面的原因就可以看到，拒绝在贪婪组模式下(<code>(...)+</code>) 的组内多模式匹配可能。即 <code>(a+a+)+</code> 是不能被允许的，而 <code>(a+b+)+</code> 是可靠的。</p>
<p>写得仓促，如有根源性错误，欢迎指正。</p>
<h2 id="参考">参考</h2>
<p><a href="https://www.regular-expressions.info/catastrophic.html">Catastrophic Backtracking(灾难性回溯)</a></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | &#39;_ \ / _` | |_ / _ \ &#39;_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div>
        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
            <div class="post-category">
              <a href="/categories/%e6%8a%80%e6%9c%af/">
                技术
              </a>
            </div>
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

        
        
        <div style="height: 50px;"></div>
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://ffutop.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="/posts/" target="_blank">Posts</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/index.xml" target="_blank">RSS</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/ffutop" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="/about/" target="_blank">About</a>
  </div>
   
  
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
      processEscapes: true
    }
  });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

 
  </body>
</html>
