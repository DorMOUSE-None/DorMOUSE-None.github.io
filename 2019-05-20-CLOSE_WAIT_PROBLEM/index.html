<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="pipe 导致的 CLOSE_WAIT">




  <meta name="keywords" content="pipe, CLOSE_WAIT, Utop's Blog">










  <link rel="alternate" href="/atom.xml" title="Utop's Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.9.0">



<link rel="canonical" href="https://DorMOUSE-None.github.io/2019-05-20-CLOSE_WAIT_PROBLEM/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.9.0">


<link href="https://fonts.googleapis.com/css?family=Noto+Sans+SC" rel="stylesheet">


<link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:400,700" rel="stylesheet">


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92258941-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-92258941-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "2IQmE2X540kOtTtNPDzsNh3e-9Nh9j0Va",
      appKey: "Vk01nlYJoGnfxJ4HCPUqW7p2"
    });
  </script>




<script>
  window.config = {"title":"Utop's Blog","subtitle":null,"description":null,"author":"Utop","language":"zh-cn","timezone":"Asia/Shanghai","url":"https://DorMOUSE-None.github.io","root":"/","permalink":":title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":true,"tab_replace":null,"first_line_number":"always1"},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":0,"pagination_dir":"page","theme":"even","deploy":{"type":"git","repo":"https://github.com/DorMOUSE-None/DorMOUSE-None.github.io.git","branch":"master","name":"DorMOUSE-None","email":"17816873960@163.com"},"ignore":[],"keywords":null,"index_generator":{"per_page":10,"order_by":"-date","path":""},"math":{"engine":"mathjax","mathjax":{"src":"//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML","config":{"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}}}},"archive_generator":{"per_page":0,"yearly":true,"monthly":true,"daily":false},"feed":{"type":"atom","limit":20,"hub":"","content":true,"content_limit":140,"content_limit_delim":"","path":"atom.xml"},"sitemap":{"path":"sitemap.xml"},"category_generator":{"per_page":0},"tag_generator":{"per_page":0},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"server":{"port":4000,"log":false,"ip":"0.0.0.0","compress":false,"header":true},"since":2018,"favicon":"/favicon.ico","rss":"default","menu":{"Home":"/","Archives":"/archives/","Tags":"/tags","About":"/about"},"color":"Default","toc":true,"fancybox":true,"pjax":true,"copyright":{"enable":true,"license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\">知识共享署名-非商业性使用 4.0 国际许可协议</a>"},"reward":{"enable":false,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"dormousenone@gmail.com","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/DorMOUSE-None","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"leancloud":{"app_id":"2IQmE2X540kOtTtNPDzsNh3e-9Nh9j0Va","app_key":"Vk01nlYJoGnfxJ4HCPUqW7p2"},"baidu_analytics":null,"baidu_verification":null,"google_analytics":"UA-92258941-1","google_verification":null,"disqus_shortname":"utop-blog","changyan":{"appid":null,"appkey":null},"livere_datauid":null,"mathjax":{"enable":true,"per_page":false,"cdn":"//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"},"version":"2.9.0"};
</script>

    <title> pipe 导致的 CLOSE_WAIT - Utop's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/." class="logo">Utop's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Utop's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          pipe 导致的 CLOSE_WAIT
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-05-20
        </span>
        
        
        <div class="post-visits" data-url="/2019-05-20-CLOSE_WAIT_PROBLEM/" data-title="pipe 导致的 CLOSE_WAIT">
            阅读次数 0
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题描述"><span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题探究"><span class="toc-text">问题探究</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CLOSE-WAIT-现象梳理"><span class="toc-text">CLOSE_WAIT 现象梳理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#打印线程调用栈-一次失败的尝试"><span class="toc-text">打印线程调用栈 (一次失败的尝试)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#打印线程调用栈"><span class="toc-text">打印线程调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重定向标准错误的原因"><span class="toc-text">重定向标准错误的原因</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <p>历时一周总算把导致服务大量 <code>CLOSE_WAIT</code> 的原因给找到了。打印任务调用栈果然的必备手段啊！</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>Python 服务 A，用于接收心跳包确认其他服务是否存活。其他服务每 5 分钟向 A 发送一次心跳包；总计 &lt; 100 个其他服务。</p>
<ul>
<li>05-11 19:30 ，首次出现 Python 服务大量 <code>CLOSE_WAIT</code>，至 13 日发现，总计 10k 左右 <code>CLOSE_WAIT</code> 的 TCP 连接。05-13 15:30 通过运维平台重新部署…</li>
<li>05-14 16:30 ，再次出现。19:30 手动重启。</li>
<li>其间给 Python 服务 A 添加了打印调用栈的模块 <a href="https://pypi.org/project/pdbx/" target="_blank" rel="noopener">pdbx</a>，通过运维平台重新部署</li>
<li>05-17 19:00 ，再次出现。等待打印调用栈，不小心杀掉了服务…</li>
<li>05-19 14:30 ，重现。</li>
<li>05-20 08:30 ，查找原因，解决问题。</li>
</ul>
<p>由于不是本人负责的服务，于 16 日凭兴趣开始有限介入，协助排查。现将排查流程一一记述，给自己和大家未来排查问题提供一个借鉴。</p>
<a id="more"></a>
<h2 id="问题探究"><a href="#问题探究" class="headerlink" title="问题探究"></a>问题探究</h2><h3 id="CLOSE-WAIT-现象梳理"><a href="#CLOSE-WAIT-现象梳理" class="headerlink" title="CLOSE_WAIT 现象梳理"></a>CLOSE_WAIT 现象梳理</h3><p>16 日拿到的信息只有前两次问题记录。</p>
<p><img src="http://img.ffutop.com/82B074FB-68FF-4A21-B664-A557FECBB2DF.png" alt=""></p>
<p>大量 <code>CLOSE_WAIT</code> 状态的 TCP 连接，<code>Recv-Q</code> 数据大小平均在 300 Bytes 左右。对比实际的 HTTP 包大小，恰好是一次 HTTP Request 请求大小。同时参考 Nginx 打印的日志，确定是一次 HTTP 请求的数据包大小，同时都以 Timeout 为结束。</p>
<p>OK，简单地建立起了第一个印象，TCP 断开连接的 FIN 包由 Nginx 请求超时后发起(<code>proxy_read_timeout 300s</code>) 。A 服务所在的 Linux 机器接收到 FIN 包，并由内核线程直接将套接字状态置位为 <code>CLOSE_WAIT</code> 。</p>
<p>A 服务没意识到 FIN 包？当然，接收了 FIN 包之后，再回应 ACK 包，这“四次挥手”的第二个数据包并不会被 A 服务所认知，而是由内核的 <code>[ksoftirqd]</code> 内核线程直接处理。看下内核处理 FIN 包的代码 (from <code>net/ipv4/tcp_input.c</code>)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 处理 FIN 包</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 如果当前套接字是 ESTABLISHED 状态，则接收 FIN 包，进入 CLOSE-WAIT</span></span><br><span class="line"><span class="comment"> * 状态 </span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tcp_fin</span><span class="params">(struct sock *sk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line"></span><br><span class="line">	inet_csk_schedule_ack(sk);</span><br><span class="line"></span><br><span class="line">	sk-&gt;sk_shutdown |= RCV_SHUTDOWN;</span><br><span class="line">	sock_set_flag(sk, SOCK_DONE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (sk-&gt;sk_state) &#123;</span><br><span class="line">	<span class="keyword">case</span> TCP_SYN_RECV:</span><br><span class="line">	<span class="keyword">case</span> TCP_ESTABLISHED:</span><br><span class="line">        <span class="comment">/* 当前为 ESTABLISHED 状态，进入 CLOSE_WAIT */</span></span><br><span class="line">		tcp_set_state(sk, TCP_CLOSE_WAIT);</span><br><span class="line">		inet_csk(sk)-&gt;icsk_ack.pingpong = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... more omitted </span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... more omitted </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更多关于网络相关的内核实现请参考 <a href="https://www.ffutop.com/2019-01-15-understand-Kernel-8/" target="_blank" rel="noopener">理解 Linux Kernel (8) - 网络</a></p>
<p>再结合 <code>Recv-Q</code> 恰好等于一次完整 HTTP 请求的条件，可以认识到 Python 线程根本没有 <code>recv</code> 请求数据。更别提意识到远端发出来 FIN 包。</p>
<p>到此为止，由前两次的问题得到的线索，只能认为 Python 服务 A 的所有工作线程都在哪段代码阻塞了。而我所能认知的唯一条件就是事务死锁（当然，我犯了比较大的错误）。事实上看代码根本就没有任何死锁代码。暂时无果。</p>
<h3 id="打印线程调用栈-一次失败的尝试"><a href="#打印线程调用栈-一次失败的尝试" class="headerlink" title="打印线程调用栈 (一次失败的尝试)"></a>打印线程调用栈 (一次失败的尝试)</h3><p>集成了调用栈打印工具 <code>pdbx</code> （强烈安利，我们老大写的，很好用的工具）之后，按理说 18 日解决问题是非常容易的。</p>
<p>结果按照文档的描述，使用 <code>kill -30 &lt;PID&gt;</code> ，Python 服务进程莫名挂掉。功亏一篑啊。后来查看源码发现 <code>pdbx</code> 重定义了 <code>USR1</code> 信号的处理函数。T_T Linux x86 平台下，对应的信号值为 10. </p>
<hr>
<p>额外地穿插一点信号相关的内容。<code>signal</code> 是一种异步处理机制，一般由执行流在退出内核态回到用户态之前 Check 当前任务的信号队列（为什么会主动 check 呢？当然是内核代码提前写好的流程），并主动针对获得的信号调用对应的信号处理函数。</p>
<p>可怕的是，之前竟然一直没有意识到信号值在不同的 CPU 架构下是不同的。USR1 在 x86 平台下是 10，在 平台下是 30 。而 BSD 又与 Linux 的编号方案不同。</p>
<blockquote>
<p>Linux  supports  the standard signals listed below.  Several signal numbers are architecture-dependent, as indicated in the “Value” column.  (Where three values are given, the first one is usually valid for alpha and sparc, the middle one for x86, arm, and most other architectures, and the last one for mips.  (Values for parisc are not shown; see the Linux kernel source for signal numbering on that architecture.)  A dash (-) denotes that a signal is absent on the corresponding architecture.<br>Linux 支持的标准信号如下。一些信号值是平台相关的（Value 列，第一个值用于 alpha 和 sparc 平台，中间的值用于 x86、arm 和大量其他架构，最后一个值用于 mips 平台）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; Signal     Value     Action   Comment</span><br><span class="line">&gt; ----------------------------------------------------------------------</span><br><span class="line">&gt; SIGHUP        1       Term    Hangup detected on controlling terminal or death of controlling process</span><br><span class="line">&gt; SIGINT        2       Term    Interrupt from keyboard</span><br><span class="line">&gt; SIGQUIT       3       Core    Quit from keyboard</span><br><span class="line">&gt; SIGKILL       9       Term    Kill signal</span><br><span class="line">&gt; SIGUSR1   30,10,16    Term    User-defined signal 1</span><br><span class="line">&gt; SIGUSR2   31,12,17    Term    User-defined signal 2</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>总结下，最靠谱的写法就是直接用信号的字符描述啦。<code>kill -s USR1 &lt;PID&gt;</code></p>
<hr>
<h3 id="打印线程调用栈"><a href="#打印线程调用栈" class="headerlink" title="打印线程调用栈"></a>打印线程调用栈</h3><p>19 日下午再次重现，等到 20 日周一上班，总是成功地拿到了线程的调用栈。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&quot;CP Server Thread-10&quot; tid=139694658537216</span><br><span class="line">    at self.__bootstrap_inner()(threading.py:785)</span><br><span class="line">    at self.run()(threading.py:812)</span><br><span class="line">    at conn.communicate()(wsgiserver2.py:1532)</span><br><span class="line">    ... more omitted</span><br><span class="line">    at instances = list(db.select(&apos;instance&apos;, vars, where=&apos;app_name=$app_name and host=$host and port=$port&apos;))(xxx.py:233)</span><br><span class="line">    at return self.query(qout, processed=True)(db.py:720)</span><br><span class="line">    at self._db_execute(db_cursor, sql_query)(db.py:680)</span><br><span class="line">    at print(&apos;%s (%s): %s&apos; % (round(b-a, 2), self.ctx.dbq_count, str(sql_query)), file=debug)(db.py:623)</span><br><span class="line">    at out.write(x)(webapi.py:512)</span><br><span class="line"></span><br><span class="line">&quot;CP Server Thread-9&quot; tid=139694666929920</span><br><span class="line">    at self.__bootstrap_inner()(threading.py:785)</span><br><span class="line">    at self.run()(threading.py:812)</span><br><span class="line">    at conn.communicate()(wsgiserver2.py:1532)</span><br><span class="line">    ... more omitted </span><br><span class="line">    at apps = list(db.select(&apos;application&apos;, vars, where=&apos;name=$name&apos;))(xxx.py:149)</span><br><span class="line">    at return self.query(qout, processed=True)(db.py:720)</span><br><span class="line">    at self._db_execute(db_cursor, sql_query)(db.py:680)</span><br><span class="line">    at print(&apos;%s (%s): %s&apos; % (round(b-a, 2), self.ctx.dbq_count, str(sql_query)), file=debug)(db.py:623)</span><br><span class="line">    at out.write(x)(webapi.py:512)</span><br><span class="line"></span><br><span class="line">&quot;MainThread&quot; tid=139695478638400</span><br><span class="line">    at app.run()(xxx.py:326)</span><br><span class="line">    at return wsgi.runwsgi(self.wsgifunc(*middleware))(application.py:341)</span><br><span class="line">    at return httpserver.runsimple(func, server_addr)(wsgi.py:59)</span><br><span class="line">    at server.start()(httpserver.py:177)</span><br><span class="line">    at self.tick()(wsgiserver2.py:1956)</span><br><span class="line">    at s, addr = self.socket.accept()(wsgiserver2.py:2008)</span><br><span class="line">    at sock, addr = self._sock.accept()(socket.py:202)</span><br><span class="line">    at pystack()(pdbx.py:181)</span><br><span class="line">    at for filename, lineno, _, line in traceback.extract_stack(stack):(pdbx.py:169)</span><br><span class="line"></span><br><span class="line">... omit CP Server Thread-1 / Thread-2 / Thread-6 / Thread-7 / Thread-8</span><br><span class="line">... same as other thread</span><br><span class="line"></span><br><span class="line">&quot;CP Server Thread-4&quot; tid=139695180908288</span><br><span class="line">    at self.__bootstrap_inner()(threading.py:785)</span><br><span class="line">    at self.run()(threading.py:812)</span><br><span class="line">    at conn.communicate()(wsgiserver2.py:1532)</span><br><span class="line">    ... more omitted </span><br><span class="line">    at instances = list(db.select(&apos;instance&apos;, vars, where=&apos;app_name=$app_name and host=$host and port=$port&apos;))(xxx.py:233)</span><br><span class="line">    at return self.query(qout, processed=True)(db.py:720)</span><br><span class="line">    at self._db_execute(db_cursor, sql_query)(db.py:680)</span><br><span class="line">    at print(&apos;%s (%s): %s&apos; % (round(b-a, 2), self.ctx.dbq_count, str(sql_query)), file=debug)(db.py:623)</span><br><span class="line">    at out.write(x)(webapi.py:512)</span><br><span class="line"></span><br><span class="line">&quot;APScheduler&quot; tid=139695219828480</span><br><span class="line">    at self.__bootstrap_inner()(threading.py:785)</span><br><span class="line">    at self.run()(threading.py:812)</span><br><span class="line">    at self.__target(*self.__args, **self.__kwargs)(threading.py:765)</span><br><span class="line">    at self._event.wait(wait_seconds)(blocking.py:28)</span><br><span class="line">    at self.__cond.wait(timeout, balancing)(threading.py:622)</span><br><span class="line">    at waiter.acquire()(threading.py:339)</span><br><span class="line"></span><br><span class="line">&quot;CP Server Thread-3&quot; tid=139695189300992</span><br><span class="line">    at self.__bootstrap_inner()(threading.py:785)</span><br><span class="line">    at self.run()(threading.py:812)</span><br><span class="line">    at conn.communicate()(wsgiserver2.py:1532)</span><br><span class="line">    ... more omitted </span><br><span class="line">    at instances = list(db.select(&apos;instance&apos;, vars, where=&apos;app_name=$app_name and host=$host and port=$port&apos;))(xxx.py:233)</span><br><span class="line">    at return self.query(qout, processed=True)(db.py:720)</span><br><span class="line">    at self._db_execute(db_cursor, sql_query)(db.py:680)</span><br><span class="line">    at print(&apos;%s (%s): %s&apos; % (round(b-a, 2), self.ctx.dbq_count, str(sql_query)), file=debug)(db.py:623)</span><br><span class="line">    at out.write(x)(webapi.py:512)</span><br><span class="line"></span><br><span class="line">&quot;CP Server Thread-5&quot; tid=139695172515584</span><br><span class="line">    at self.__bootstrap_inner()(threading.py:785)</span><br><span class="line">    at self.run()(threading.py:812)</span><br><span class="line">    at conn.communicate()(wsgiserver2.py:1532)</span><br><span class="line">    ... more omitted </span><br><span class="line">    at instances = list(db.select(&apos;instance&apos;, vars, where=&apos;app_name=$app_name and host=$host and port=$port&apos;))(xxx.py:233)</span><br><span class="line">    at return self.query(qout, processed=True)(db.py:720)</span><br><span class="line">    at self._db_execute(db_cursor, sql_query)(db.py:680)</span><br><span class="line">    at print(&apos;%s (%s): %s&apos; % (round(b-a, 2), self.ctx.dbq_count, str(sql_query)), file=debug)(db.py:623)</span><br><span class="line">    at out.write(x)(webapi.py:512)</span><br></pre></td></tr></table></figure>
<p>OK，总计 10 个工作线程，全都阻塞在 <code>out.write(x)</code> ，多次打印调用栈结果相同。基本可以断定是 <code>write</code> 方法出了问题了。不过直到这个时候，都还是深陷在死锁原因中无法自拔（还是接触得太少了）。</p>
<p>虚度半个多钟… 后看代码了解到，其准备将 SQL 执行结果打印到标准错误。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_debugwrite</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        out = ctx.environ[<span class="string">'wsgi.errors'</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        out = sys.stderr</span><br><span class="line">    out.write(x)</span><br><span class="line">debug.write = _debugwrite</span><br></pre></td></tr></table></figure>
<p>果断去查看 Python 服务的文件描述符 <code>lsof -p &lt;PID&gt;</code> / <code>ls -al /proc/&lt;PID&gt;/fd</code> 。总算见着可信的证据了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; lsof -p &lt;PID&gt;</span><br><span class="line">python  139756 sysop    0r  FIFO     0,9       0t0 5210639 pipe</span><br><span class="line">python  139756 sysop    1w   REG   253,1      5187 1188500 /home/www/wwwroot/logs/eswitch-console.9999.log</span><br><span class="line">python  139756 sysop    2w  FIFO     0,9       0t0 5210641 pipe</span><br><span class="line">python  139756 sysop    3u  IPv4 5210787       0t0     TCP 10.1.5.60:65442-&gt;10.1.6.104:mysql (ESTABLISHED)</span><br><span class="line">python  139756 sysop    4r  FIFO     0,9       0t0 5210774 pipe</span><br><span class="line">python  139756 sysop    5w  FIFO     0,9       0t0 5210774 pipe</span><br><span class="line">python  139756 sysop    6r  FIFO     0,9       0t0 5210778 pipe</span><br><span class="line">python  139756 sysop    7w  FIFO     0,9       0t0 5210778 pipe</span><br><span class="line">python  139756 sysop    8u  IPv4 5210788       0t0     TCP *:distinct (LISTEN)</span><br><span class="line">python  139756 sysop    9u  IPv4 5226722       0t0     TCP localhost:distinct-&gt;localhost:26032 (CLOSE_WAIT)</span><br><span class="line">python  139756 sysop   10u  IPv4 5226858       0t0     TCP localhost:distinct-&gt;localhost:26052 (CLOSE_WAIT)</span><br><span class="line">... more omitted</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; ls -al /proc/&lt;PID&gt;/fd</span><br><span class="line">lr-x------ 1 sysop sysop 64 May 20 13:47 0 -&gt; pipe:[5210639]</span><br><span class="line">l-wx------ 1 sysop sysop 64 May 20 13:47 1 -&gt; /home/path/to/logs/xxx.log</span><br><span class="line">l-wx------ 1 sysop sysop 64 May 20 13:47 2 -&gt; pipe:[5210641]</span><br><span class="line">lrwx------ 1 sysop sysop 64 May 20 13:47 3 -&gt; socket:[5210787]</span><br><span class="line">lr-x------ 1 sysop sysop 64 May 20 13:47 4 -&gt; pipe:[5210774]</span><br><span class="line">l-wx------ 1 sysop sysop 64 May 20 13:47 5 -&gt; pipe:[5210774]</span><br><span class="line">lr-x------ 1 sysop sysop 64 May 20 13:47 6 -&gt; pipe:[5210778]</span><br><span class="line">l-wx------ 1 sysop sysop 64 May 20 13:47 7 -&gt; pipe:[5210778]</span><br><span class="line">... more omitted</span><br></pre></td></tr></table></figure>
<p>标准错误(fd = 2)指向了一个匿名管道（inode = 5210641）。但是找遍整个系统都没有这个匿名管道的读取方，只有写入方</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; sudo lsof | grep 5210641</span><br><span class="line">bash      139747          sysop    2w     FIFO                0,9       0t0    5210641 pipe</span><br><span class="line">python    139756          sysop    2w     FIFO                0,9       0t0    5210641 pipe</span><br><span class="line">python    139756 139764   sysop    2w     FIFO                0,9       0t0    5210641 pipe</span><br></pre></td></tr></table></figure>
<p>OK，合理的解释出现了。管道的缓冲区大小有限(经过测试是 64KB)，Python 服务在不断地向标准错误打印日志，从而导致匿名管道(inode = 5210641)的缓冲区数据不断积累，最终达到满的状态。这个过程大概需要一天多的心跳包才能积累得到。而系统调用 <code>write</code> 发现标准错误对应的文件已满，为等待 IO 就绪而陷入睡眠状态。同时，Main 线程在不断地 Accept 新的套接字的建立，而没有更多工作线程来处理新的请求，Nginx 因为连接超时直接发出来 FIN 包。最后，积累了几千/上万请求的 Python 服务也没法主动 close 已有的套接字（即 FIN,ACK 包因为没法发送而在本机不断积累 <code>CLOSE_WAIT</code> 状态的连接）</p>
<h3 id="重定向标准错误的原因"><a href="#重定向标准错误的原因" class="headerlink" title="重定向标准错误的原因"></a>重定向标准错误的原因</h3><p>至于为何会将标准错误重定向到一个匿名管道呢？百思不得其解，不过最后还是从应用负责人那儿得到了提示。新的发布方式采用了全新的启动命令:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fn xx.xx.x.60 <span class="string">'cd /home/path/to/xxx ; python -u xxx.py 8080 &gt;&gt; /home/path/to/logs/xxx.log'</span></span><br></pre></td></tr></table></figure>
<p>一看就能和前面的原因衔接，使用 ssh 直接调用命名，不会建立一个终端，由 ssh 远程命令启动的任务，其标准输入/输出/错误默认将会通过管道重定向的 ssh server 端，并通过网络传回发起的 ssh client 端。</p>
<p><em>以发起 <code>ssh -fn ...</code> 的机器为 xx.192，目标机器为 xx.60</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">xx.192                       |           xx.60</span><br><span class="line">-----------------------------+-------------------------------</span><br><span class="line">                             | </span><br><span class="line">  ssh client                 |          ssh serve           python serve</span><br><span class="line">+------------+               |        +------------+       +-------------+</span><br><span class="line">| 0 | stdin  |               |        | y | pipe[a]| &lt;---&gt; | 0 | pipe[a] |</span><br><span class="line">| 1 | stdout |               |        | z | pipe[b]| &lt;-+   | 1 | xxx.log |</span><br><span class="line">| 2 | stderr |               |        |   |        |   +-&gt; | 2 | pipe[b] |</span><br><span class="line">| ...        |               |        | ...        |       | ...         |</span><br><span class="line">| x | sock   | &lt;--------------------&gt; | w | sock   |       | ...         |</span><br><span class="line">+------------+               |        +------------+       +-------------+</span><br></pre></td></tr></table></figure>
<p>Python 服务通过管道与 ssh serve 进行进程间交互，最终会将标准错误打印到 192 机器的标准输出/错误上（一般是终端，也就是我们将在终端上看到 Python 服务的错误日志）。而问题在于 ssh serve 任务被杀掉了，从而 <code>pipe[b]</code> 只能不断地向匿名管道写入数据，而没有任务读取数据，一天多时间也就将缓冲区写满了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到此为止，问题总算得到了圆满的解释，历时 5 天。最重要的就是通过调用栈定位代码阻塞的原因，否则就真是瞎找。对于匿名管道问题的发现、write 系统调用导致的线程睡眠，都是建立在调用栈信息之上的定向探究的过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  __                    __                  </span><br><span class="line"> / _| __ _ _ __   __ _ / _| ___ _ __   __ _ </span><br><span class="line">| |_ / _` | &apos;_ \ / _` | |_ / _ \ &apos;_ \ / _` |</span><br><span class="line">|  _| (_| | | | | (_| |  _|  __/ | | | (_| |</span><br><span class="line">|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |</span><br><span class="line">                 |___/                |___/</span><br></pre></td></tr></table></figure>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://DorMOUSE-None.github.io">Utop</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://DorMOUSE-None.github.io/2019-05-20-CLOSE_WAIT_PROBLEM/">https://DorMOUSE-None.github.io/2019-05-20-CLOSE_WAIT_PROBLEM/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/pipe/">pipe</a>
            
              <a href="/tags/CLOSE-WAIT/">CLOSE_WAIT</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2019-05-10-png-structure/">
        <span class="next-text nav-default">PNG 文件格式</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:dormousenone@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/DorMOUSE-None" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2018 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Utop</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://DorMOUSE-None.github.io/2019-05-20-CLOSE_WAIT_PROBLEM/';
        this.page.identifier = '2019-05-20-CLOSE_WAIT_PROBLEM/';
        this.page.title = 'pipe 导致的 CLOSE_WAIT';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//utop-blog.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.9.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

  </body>
</html>
